---
phase: 14-cli-manifest-mode
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/x402lint/package.json
  - packages/x402lint/src/cli/args.ts
  - packages/x402lint/src/cli/fetch.ts
  - packages/x402lint/src/cli/detect.ts
autonomous: true

must_haves:
  truths:
    - "CLI accepts --header flag multiple times and collects all values"
    - "CLI auto-detects manifest vs single-config from parsed JSON"
    - "URL fetching follows redirects up to 5 hops with 10s timeout"
    - "stdin reads from dash (-) positional argument"
  artifacts:
    - path: "packages/x402lint/src/cli/args.ts"
      provides: "CLI argument parsing with util.parseArgs"
      exports: ["parseCliArgs", "CliArgs"]
    - path: "packages/x402lint/src/cli/fetch.ts"
      provides: "URL fetching with redirect tracking and custom headers"
      exports: ["fetchWithRedirects"]
    - path: "packages/x402lint/src/cli/detect.ts"
      provides: "Input type detection and loading (file, URL, stdin, inline JSON, manifest vs config)"
      exports: ["loadInput", "InputResult"]
  key_links:
    - from: "packages/x402lint/src/cli/args.ts"
      to: "node:util"
      via: "parseArgs import"
      pattern: "import.*parseArgs.*from.*node:util"
    - from: "packages/x402lint/src/cli/fetch.ts"
      to: "native fetch"
      via: "redirect: manual with loop"
      pattern: "redirect.*manual"
    - from: "packages/x402lint/src/cli/detect.ts"
      to: "packages/x402lint/src/detection/detect.ts"
      via: "detect() import for format detection"
      pattern: "import.*detect.*from"
---

<objective>
Create CLI infrastructure modules: argument parsing with repeatable `--header` flags, URL fetching with redirect tracking, and input detection/loading that distinguishes manifests from single configs.

Purpose: Extract CLI concerns into focused modules so Plan 02 can compose them into the manifest-aware CLI flow.
Output: Three new files in `src/cli/` providing args, fetch, and input detection capabilities.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-cli-manifest-mode/14-CONTEXT.md
@.planning/phases/14-cli-manifest-mode/14-RESEARCH.md
@packages/x402lint/src/cli.ts
@packages/x402lint/src/index.ts
@packages/x402lint/src/detection/detect.ts
@packages/x402lint/src/detection/guards.ts
@packages/x402lint/src/detection/wild-manifest.ts
@packages/x402lint/src/types/manifest.ts
@packages/x402lint/package.json
@packages/x402lint/tsdown.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install cli-table3 and create args module</name>
  <files>
    packages/x402lint/package.json
    packages/x402lint/src/cli/args.ts
  </files>
  <action>
    1. Install cli-table3 as a devDependency: `pnpm add -D cli-table3` in packages/x402lint/.
       cli-table3 is a devDep because tsdown bundles it into cli.mjs (same pattern as @noble/hashes).

    2. Create `src/cli/args.ts` using `util.parseArgs()` from `node:util`:

    Export interface `CliArgs`:
    - `input: string | null` (positional argument)
    - `strict: boolean`
    - `json: boolean`
    - `quiet: boolean`
    - `help: boolean`
    - `version: boolean`
    - `headers: Record<string, string>` (parsed from --header flags)

    Export function `parseCliArgs(argv: string[]): CliArgs` that:
    - Uses `parseArgs()` with options:
      - `strict: { type: 'boolean' }`
      - `json: { type: 'boolean' }`
      - `quiet: { type: 'boolean', short: 'q' }`
      - `help: { type: 'boolean', short: 'h' }`
      - `version: { type: 'boolean', short: 'v' }`
      - `header: { type: 'string', multiple: true }` (repeatable)
    - Uses `allowPositionals: true`
    - Converts header array to Record by splitting on first `:` (key: value)
    - First positional becomes `input`
    - Returns the CliArgs object with all defaults (false for booleans, {} for headers, null for input)

    Important: Do NOT include `-s` as short for `--strict` to avoid conflict. The existing CLI uses `--strict` without a short flag.
  </action>
  <verify>
    Run `pnpm --filter x402lint exec tsc --noEmit` to verify types compile.
    Verify cli-table3 appears in devDependencies in package.json.
  </verify>
  <done>
    `src/cli/args.ts` exports parseCliArgs with repeatable --header support.
    cli-table3 is installed as devDependency.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create fetch module with redirect tracking</name>
  <files>packages/x402lint/src/cli/fetch.ts</files>
  <action>
    Create `src/cli/fetch.ts` with:

    Export interface `FetchResult`:
    - `status: number`
    - `body: unknown`
    - `headers: Record<string, string>`

    Export async function `fetchWithRedirects(url: string, options?: { headers?: Record<string, string>; maxRedirects?: number; timeoutMs?: number }): Promise<FetchResult>` that:

    1. Defaults: maxRedirects = 5, timeoutMs = 10000
    2. Loop up to maxRedirects:
       - `fetch(currentUrl, { redirect: 'manual', signal: AbortSignal.timeout(timeoutMs), headers: options?.headers })`
       - If status is 301/302/303/307/308:
         - Read Location header
         - If no Location, throw Error('Redirect without Location header')
         - Increment redirect count; if > maxRedirects, throw Error(`Too many redirects (limit: ${maxRedirects})`)
         - Resolve relative URL: `new URL(location, currentUrl).href`
         - Continue loop
       - Otherwise, process response:
         - Collect headers into Record<string, string>
         - Parse body: if content-type includes 'json', use `res.json()`, else `res.text()`
         - Return { status, body, headers }
    3. If loop exhausts without return, throw Error('Redirect loop detected')

    This replaces the simple `fetchUrl()` in the existing cli.ts. The new version:
    - Has configurable timeout (existing had none)
    - Tracks redirect count (existing followed all redirects automatically)
    - Accepts custom headers (for --header flag support)
  </action>
  <verify>
    Run `pnpm --filter x402lint exec tsc --noEmit` to verify types compile.
  </verify>
  <done>
    `src/cli/fetch.ts` exports fetchWithRedirects with redirect tracking, timeout, and custom headers.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create input detection/loading module</name>
  <files>packages/x402lint/src/cli/detect.ts</files>
  <action>
    Create `src/cli/detect.ts` that handles all input resolution and format detection.

    Export type `InputType = 'manifest' | 'single-config' | 'url'`

    Export interface `InputResult`:
    - `type: InputType`
    - `data: unknown` (parsed JSON for manifest/single-config, or the URL string for url type)
    - `normalizationWarnings?: string[]` (wild manifest normalization messages)

    Export function `isUrl(s: string): boolean` — returns true if starts with http:// or https://

    Export function `isJsonLike(s: string): boolean` — returns true if trimmed starts with { or [

    Export function `readStdin(): Promise<string>` — same pattern as existing cli.ts:
    - If `process.stdin.isTTY`, resolve with ''
    - Otherwise read chunks until 'end', return concatenated string

    Export function `resolveInput(rawInput: string): InputResult`:
    This takes the raw string input (after determining it's not a URL) and:
    1. If not JSON-like, try to read as file:
       - `resolve(rawInput)` to get absolute path
       - If file doesn't exist, throw Error(`File not found: ${filePath}`)
       - Read file with `readFileSync(filePath, 'utf-8')`
       - Now rawInput is the file contents
    2. Parse the JSON string
       - If parse fails, return `{ type: 'single-config', data: rawInput }` (let validate() handle the parse error)
    3. Detect format using `detect()` from `../../detection/detect`
       - If format is 'manifest', return `{ type: 'manifest', data: parsed }`
       - If format is 'unknown', try wild manifest normalization:
         - Import `normalizeWildManifest` from `../../detection/wild-manifest`
         - If normalization succeeds, return `{ type: 'manifest', data: wildResult.manifest, normalizationWarnings: wildResult.warnings.map(w => w.message) }`
       - Otherwise return `{ type: 'single-config', data: parsed }`

    Important: This module uses `node:fs` and `node:path` — CLI-only, not bundled into library.

    Import `detect` from `../detection/detect` and `normalizeWildManifest` from `../detection/wild-manifest`.

    Note on `-` (dash) stdin convention: The main CLI flow (in Plan 02) will handle `-` as a special positional arg that triggers stdin reading. This module just needs the resolveInput and readStdin functions.
  </action>
  <verify>
    Run `pnpm --filter x402lint exec tsc --noEmit` to verify types compile.
  </verify>
  <done>
    `src/cli/detect.ts` exports resolveInput, readStdin, isUrl, isJsonLike with manifest auto-detection and wild manifest normalization.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter x402lint exec tsc --noEmit` passes with no type errors
2. All three new files exist in `src/cli/` with correct exports
3. cli-table3 is listed in devDependencies
4. No changes to existing `src/cli.ts` yet (Plan 02 handles the rewrite)
</verification>

<success_criteria>
- Three CLI module files created with correct TypeScript types
- cli-table3 installed as devDependency
- Type checking passes
- Modules are self-contained and importable
</success_criteria>

<output>
After completion, create `.planning/phases/14-cli-manifest-mode/14-01-SUMMARY.md`
</output>
