---
phase: 14-cli-manifest-mode
plan: 03
type: execute
wave: 3
depends_on: ["14-02"]
files_modified:
  - packages/x402lint/test/fixtures/valid-manifest.json
  - packages/x402lint/test/fixtures/invalid-manifest.json
  - packages/x402lint/test/cli.test.ts
autonomous: true

must_haves:
  truths:
    - "CLI manifest detection and output is verified by automated tests"
    - "Single-config CLI behavior has no regressions"
    - "All flag combinations tested (--json, --quiet, --strict with manifests)"
    - "Exit codes verified (0 majority pass, 1 majority fail, 2 input error)"
    - "All existing CLI tests continue to pass"
  artifacts:
    - path: "packages/x402lint/test/fixtures/valid-manifest.json"
      provides: "Test fixture for valid manifest with 2+ endpoints"
    - path: "packages/x402lint/test/fixtures/invalid-manifest.json"
      provides: "Test fixture for manifest with at least one failing endpoint"
    - path: "packages/x402lint/test/cli.test.ts"
      provides: "Updated CLI tests covering manifest mode"
      min_lines: 150
  key_links:
    - from: "packages/x402lint/test/cli.test.ts"
      to: "packages/x402lint/dist/cli.mjs"
      via: "execFileSync to run CLI binary"
      pattern: "execFileSync.*cli.mjs"
---

<objective>
Add test fixtures for manifests and comprehensive CLI tests verifying manifest detection, output formatting, flag composition, and exit codes.

Purpose: Verify all 5 success criteria from the phase roadmap with automated tests.
Output: Test fixtures and updated CLI test suite covering manifest mode.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-cli-manifest-mode/14-CONTEXT.md
@.planning/phases/14-cli-manifest-mode/14-02-SUMMARY.md
@packages/x402lint/test/cli.test.ts
@packages/x402lint/test/fixtures/valid-v2-base.json
@packages/x402lint/src/cli.ts
@packages/x402lint/src/cli/format.ts
@packages/x402lint/src/types/manifest.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create manifest test fixtures</name>
  <files>
    packages/x402lint/test/fixtures/valid-manifest.json
    packages/x402lint/test/fixtures/invalid-manifest.json
  </files>
  <action>
    Create two manifest test fixture files.

    **valid-manifest.json** - A valid manifest with 2 endpoints, both passing validation:
    ```json
    {
      "x402Version": 2,
      "service": {
        "name": "Test API",
        "url": "https://api.example.com"
      },
      "endpoints": {
        "api/weather": {
          "x402Version": 2,
          "accepts": [{
            "scheme": "exact",
            "network": "eip155:8453",
            "amount": "1000000",
            "asset": "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",
            "payTo": "0x5aAeb6053F3E94C9b9A09f33669435E7Ef1BeAed",
            "maxTimeoutSeconds": 60
          }],
          "resource": { "url": "https://api.example.com/weather" }
        },
        "api/maps": {
          "x402Version": 2,
          "accepts": [{
            "scheme": "exact",
            "network": "eip155:8453",
            "amount": "2000000",
            "asset": "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",
            "payTo": "0x5aAeb6053F3E94C9b9A09f33669435E7Ef1BeAed",
            "maxTimeoutSeconds": 120
          }],
          "resource": { "url": "https://api.example.com/maps" }
        }
      }
    }
    ```
    Use real checksummed EVM addresses (0x5aAeb6053F3E94C9b9A09f33669435E7Ef1BeAed is valid EIP-55, 0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913 is real USDC on Base).

    **invalid-manifest.json** - A manifest with 3 endpoints: 2 valid, 1 invalid (majority pass -> exit 0):
    Same as valid-manifest.json but add a third endpoint with invalid config:
    ```json
    "api/broken": {
      "x402Version": 2,
      "accepts": [],
      "resource": { "url": "https://api.example.com/broken" }
    }
    ```
    This endpoint has empty accepts (EMPTY_ACCEPTS error), so 2/3 endpoints pass = majority pass = exit 0.

    Also create a fixture where majority fail for exit code 1 testing. This can be done inline in the test rather than a fixture — create JSON in the test with 2 invalid + 1 valid endpoint.
  </action>
  <verify>
    Files exist and contain valid JSON: `node -e "require('./packages/x402lint/test/fixtures/valid-manifest.json')"` and similar for invalid.
  </verify>
  <done>
    Two manifest fixture files created with realistic data using checksummed addresses.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add manifest CLI tests to cli.test.ts</name>
  <files>packages/x402lint/test/cli.test.ts</files>
  <action>
    Extend the existing cli.test.ts with new describe blocks for manifest mode. Keep ALL existing tests intact.

    Build CLI first before running tests: the test file uses `dist/cli.mjs`, so ensure build is fresh.

    **New test groups to add:**

    **`describe('cli -- manifest detection')`:**
    - `test('valid manifest file: exits 0, shows summary table')`:
      Run with valid-manifest.json fixture. Assert exit 0. Assert stdout contains "Detected: manifest with 2 endpoints". Assert stdout contains "api/weather" and "api/maps" (endpoint IDs in output).
    - `test('manifest with majority pass: exits 0')`:
      Run with invalid-manifest.json (2 valid + 1 invalid). Assert exit 0 (majority pass).
    - `test('manifest with majority fail: exits 1')`:
      Create inline JSON with 1 valid + 2 invalid endpoints. Assert exit 1.
    - `test('single config still detected correctly')`:
      Run with valid-v2-base.json fixture. Assert exit 0. Assert stdout contains "Detected:" and "config" (detection announcement for single config).

    **`describe('cli -- manifest --json')`:**
    - `test('manifest --json outputs parseable JSON')`:
      Run with `--json` and valid-manifest.json. Assert exit 0. `JSON.parse(stdout)` succeeds. Assert parsed has `endpointResults` property. Assert parsed has `valid` property. Assert no ANSI codes in stdout (no `\x1b` characters).
    - `test('manifest --json with invalid: parseable JSON with errors')`:
      Run with `--json` and invalid-manifest.json. JSON.parse succeeds. Assert parsed.endpointResults has entries.

    **`describe('cli -- manifest --quiet')`:**
    - `test('manifest --quiet: no output, exit 0 on majority pass')`:
      Run with `--quiet` and valid-manifest.json. Assert stdout.trim() === ''. Assert exit 0.
    - `test('manifest --quiet: no output, exit 1 on majority fail')`:
      Create inline JSON manifest with majority invalid. Assert stdout.trim() === ''. Assert exit 1.

    **`describe('cli -- manifest --strict')`:**
    - `test('--strict promotes manifest warnings to errors')`:
      Create a manifest that would normally have cross-endpoint warnings (e.g., mixed mainnet+testnet networks). Without --strict: exit 0. With --strict: exit 1.
    - `test('--strict --json outputs strict-mode JSON')`:
      Run with --strict --json on a manifest with warnings. Parse JSON. In strict mode, the warnings array should be empty and errors should contain the promoted warnings. OR the valid field should be false if warnings were promoted.

    **`describe('cli -- manifest flag composition')`:**
    - `test('--quiet takes precedence over --json')`:
      Run with `--quiet --json` and valid-manifest.json. Assert stdout.trim() === '' (quiet wins).
    - `test('--strict --quiet: exit code reflects strict validation')`:
      Use manifest with warnings. --strict --quiet should exit 1 with no output.

    **`describe('cli -- dash stdin for manifest')`:**
    - `test('dash reads manifest from stdin')`:
      Run with `['-']` and input: valid manifest JSON. Assert exit 0. Assert stdout contains "Detected: manifest".

    Important: All tests use the same `run()` helper already in cli.test.ts. Add the FIXTURES constant for the new manifest fixture paths. Build must be run before tests (`pnpm --filter x402lint build`).
  </action>
  <verify>
    1. `pnpm --filter x402lint build` succeeds
    2. `pnpm --filter x402lint test` — all tests pass (both existing and new)
    3. Verify test count increased (should add ~12-15 new test cases)
  </verify>
  <done>
    All 5 phase success criteria covered by tests:
    1. manifest.json auto-detected, per-endpoint summaries shown
    2. config.json works unchanged (existing tests + new detection test)
    3. --json outputs parseable JSON without ANSI codes
    4. --quiet suppresses output, exit code only
    5. Flag combinations compose correctly (--strict --json, --quiet precedence)
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter x402lint build && pnpm --filter x402lint test` — all pass
2. New test count: ~12-15 additional test cases in cli.test.ts
3. All existing CLI tests still pass (no regression)
4. Test coverage touches all 5 success criteria from the phase roadmap
</verification>

<success_criteria>
- All existing CLI tests pass unchanged
- Manifest detection, output, and exit codes verified by tests
- Flag composition (--json, --quiet, --strict) tested with manifests
- Dash stdin tested with manifest input
- No ANSI codes in --json output (verified by test)
</success_criteria>

<output>
After completion, create `.planning/phases/14-cli-manifest-mode/14-03-SUMMARY.md`
</output>
