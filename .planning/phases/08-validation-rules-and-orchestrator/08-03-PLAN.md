---
phase: 08-validation-rules-and-orchestrator
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - packages/x402lint/test/validation/rules/structure.test.ts
  - packages/x402lint/test/validation/rules/version.test.ts
  - packages/x402lint/test/validation/rules/fields.test.ts
  - packages/x402lint/test/validation/rules/network.test.ts
  - packages/x402lint/test/validation/rules/amount.test.ts
  - packages/x402lint/test/validation/rules/legacy.test.ts
  - packages/x402lint/test/validation/orchestrator.test.ts
  - packages/x402lint/test/fixtures/valid-v2-base.json
  - packages/x402lint/test/fixtures/valid-v2-solana.json
  - packages/x402lint/test/fixtures/valid-v1.json
  - packages/x402lint/test/fixtures/valid-flat.json
  - packages/x402lint/test/fixtures/invalid-no-accepts.json
  - packages/x402lint/test/fixtures/invalid-bad-network.json
  - packages/x402lint/test/fixtures/real-world/coinbase-x402-sample.json
  - packages/x402lint/test/integration.test.ts
autonomous: true

must_haves:
  truths:
    - "Every ErrorCode constant has at least one test that produces it"
    - "The test suite has 100+ test cases total (count via vitest --reporter=verbose)"
    - "All tests pass with zero failures"
    - "Integration tests cover real-world config fixtures loaded from JSON files"
    - "Round-trip tests verify normalize() output validates without errors"
    - "Strict mode tests confirm warnings are promoted to errors"
    - "INVALID_URL error code is exercised by tests with malformed resource URLs"
    - "INVALID_TIMEOUT error code is exercised by tests with non-integer, non-positive, and non-number timeout values"
  artifacts:
    - path: "packages/x402lint/test/validation/rules/structure.test.ts"
      provides: "Structure rule unit tests"
      min_lines: 30
    - path: "packages/x402lint/test/validation/rules/fields.test.ts"
      provides: "Fields rule unit tests including URL format validation"
      min_lines: 50
    - path: "packages/x402lint/test/validation/rules/network.test.ts"
      provides: "Network rule unit tests with fix suggestion checks"
      min_lines: 40
    - path: "packages/x402lint/test/validation/rules/amount.test.ts"
      provides: "Amount and timeout rule unit tests"
      min_lines: 40
    - path: "packages/x402lint/test/validation/orchestrator.test.ts"
      provides: "Orchestrator integration tests covering full pipeline"
      min_lines: 100
    - path: "packages/x402lint/test/integration.test.ts"
      provides: "End-to-end tests with JSON fixtures and round-trips"
      min_lines: 80
    - path: "packages/x402lint/test/fixtures/valid-v2-base.json"
      provides: "Valid v2 config fixture for Base network"
    - path: "packages/x402lint/test/fixtures/valid-v1.json"
      provides: "Valid v1 config fixture"
  key_links:
    - from: "packages/x402lint/test/validation/orchestrator.test.ts"
      to: "packages/x402lint/src/validation/orchestrator.ts"
      via: "imports validate()"
      pattern: "import.*validate.*orchestrator"
    - from: "packages/x402lint/test/integration.test.ts"
      to: "packages/x402lint/test/fixtures/"
      via: "imports JSON fixture files"
      pattern: "import.*fixtures"
---

<objective>
Create a comprehensive test suite with 100+ test cases covering every validation rule, every error code, JSON fixtures, round-trip validation, and strict mode behavior.

Purpose: The test suite proves the validate() API works correctly for all input scenarios. Every error code must be exercised -- including the new INVALID_URL and INVALID_TIMEOUT codes. JSON fixtures enable reproducible testing and serve as documentation of expected behavior. The 100+ test case target ensures comprehensive coverage.

Output: 6 rule unit test files, 1 orchestrator test file, 1 integration test file, 7+ JSON fixture files.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-validation-rules-and-orchestrator/08-RESEARCH.md
@.planning/phases/08-validation-rules-and-orchestrator/08-01-SUMMARY.md
@.planning/phases/08-validation-rules-and-orchestrator/08-02-SUMMARY.md

@packages/x402lint/src/types/errors.ts
@packages/x402lint/src/types/config.ts
@packages/x402lint/src/validation/orchestrator.ts
@packages/x402lint/src/validation/rules/index.ts
@packages/x402lint/test/validation/address.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create JSON fixtures and rule unit tests</name>
  <files>
    packages/x402lint/test/fixtures/valid-v2-base.json
    packages/x402lint/test/fixtures/valid-v2-solana.json
    packages/x402lint/test/fixtures/valid-v1.json
    packages/x402lint/test/fixtures/valid-flat.json
    packages/x402lint/test/fixtures/invalid-no-accepts.json
    packages/x402lint/test/fixtures/invalid-bad-network.json
    packages/x402lint/test/fixtures/real-world/coinbase-x402-sample.json
    packages/x402lint/test/validation/rules/structure.test.ts
    packages/x402lint/test/validation/rules/version.test.ts
    packages/x402lint/test/validation/rules/fields.test.ts
    packages/x402lint/test/validation/rules/network.test.ts
    packages/x402lint/test/validation/rules/amount.test.ts
    packages/x402lint/test/validation/rules/legacy.test.ts
  </files>
  <action>
**JSON Fixtures** (create in `packages/x402lint/test/fixtures/`):

`valid-v2-base.json`:
```json
{
  "x402Version": 2,
  "accepts": [{
    "scheme": "exact",
    "network": "eip155:8453",
    "amount": "1000000",
    "asset": "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",
    "payTo": "0x5aAeb6053F3E94C9b9A09f33669435E7Ef1BeAed",
    "maxTimeoutSeconds": 300
  }],
  "resource": { "url": "https://example.com/api/data" }
}
```

`valid-v2-solana.json`:
```json
{
  "x402Version": 2,
  "accepts": [{
    "scheme": "exact",
    "network": "solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp",
    "amount": "1000000",
    "asset": "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v",
    "payTo": "11111111111111111111111111111111",
    "maxTimeoutSeconds": 60
  }],
  "resource": { "url": "https://example.com/api/premium" }
}
```

`valid-v1.json`:
```json
{
  "x402Version": 1,
  "accepts": [{
    "scheme": "exact",
    "network": "eip155:8453",
    "maxAmountRequired": "500000",
    "asset": "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",
    "payTo": "0x5aAeb6053F3E94C9b9A09f33669435E7Ef1BeAed",
    "maxTimeoutSeconds": 120,
    "resource": { "url": "https://example.com/api/v1" }
  }]
}
```

`valid-flat.json`:
```json
{
  "payTo": "0x5aAeb6053F3E94C9b9A09f33669435E7Ef1BeAed",
  "amount": "1000000",
  "network": "base",
  "asset": "USDC"
}
```

`invalid-no-accepts.json`:
```json
{
  "x402Version": 2,
  "resource": { "url": "https://example.com/api/data" }
}
```

`invalid-bad-network.json`:
```json
{
  "x402Version": 2,
  "accepts": [{
    "scheme": "exact",
    "network": "not-a-caip2",
    "amount": "1000000",
    "asset": "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",
    "payTo": "0x5aAeb6053F3E94C9b9A09f33669435E7Ef1BeAed"
  }],
  "resource": { "url": "https://example.com" }
}
```

`real-world/coinbase-x402-sample.json` (realistic config based on x402 spec):
```json
{
  "x402Version": 2,
  "accepts": [
    {
      "scheme": "exact",
      "network": "eip155:8453",
      "amount": "100000",
      "asset": "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",
      "payTo": "0x5aAeb6053F3E94C9b9A09f33669435E7Ef1BeAed",
      "maxTimeoutSeconds": 300,
      "extra": {
        "name": "Example API",
        "version": "1.0.0"
      }
    }
  ],
  "resource": {
    "url": "https://api.example.com/v1/premium-data",
    "method": "GET"
  }
}
```

**Rule Unit Tests** (create in `packages/x402lint/test/validation/rules/`):

All tests import from `vitest` (`import { describe, test, expect } from 'vitest'`).

**structure.test.ts** (~8 tests):
- Invalid JSON string returns INVALID_JSON error
- JSON number returns NOT_OBJECT error
- JSON array `'[]'` returns NOT_OBJECT error
- JSON null returns NOT_OBJECT error
- Empty object `'{}'` returns UNKNOWN_FORMAT error
- Valid v2 object returns format 'v2' with no issues
- Valid v1 object returns format 'v1' with no issues
- Flat-legacy object returns format 'flat-legacy' with no issues

**version.test.ts** (~4 tests):
- NormalizedConfig with x402Version:2 returns no issues
- NormalizedConfig with x402Version set to 3 returns INVALID_VERSION error
- NormalizedConfig with x402Version set to 0 returns INVALID_VERSION error
- NormalizedConfig with x402Version:1 from v1 normalization returns no issues (normalize converts to 2)

**fields.test.ts** (~16 tests):
- validateFields: entry missing scheme returns MISSING_SCHEME
- validateFields: entry missing network returns MISSING_NETWORK
- validateFields: entry missing amount returns MISSING_AMOUNT
- validateFields: entry missing asset returns MISSING_ASSET
- validateFields: entry missing payTo returns MISSING_PAY_TO
- validateFields: entry with empty string scheme returns MISSING_SCHEME
- validateFields: complete entry returns no issues
- validateFields: entry missing all fields returns 5 issues
- validateAccepts: config without accepts returns MISSING_ACCEPTS or INVALID_ACCEPTS
- validateAccepts: config with empty accepts returns EMPTY_ACCEPTS
- validateAccepts: config with valid accepts returns no issues
- validateResource: v2 config without resource returns MISSING_RESOURCE warning
- **validateResource: config with valid URL 'https://example.com/api' returns no INVALID_URL issues**
- **validateResource: config with malformed URL 'not-a-url' returns INVALID_URL warning**
- **validateResource: config with empty-protocol URL '://bad' returns INVALID_URL warning**
- **validateResource: config with resource.url empty string returns MISSING_RESOURCE warning (no INVALID_URL since empty is caught first)**

**network.test.ts** (~10 tests):
- Missing network returns no issues (handled by fields)
- Valid CAIP-2 known network returns no issues
- Valid CAIP-2 unknown network returns UNKNOWN_NETWORK warning
- Invalid CAIP-2 with simple name 'base' returns INVALID_NETWORK_FORMAT error with fix
- Invalid CAIP-2 with simple name 'solana' returns fix suggestion
- Invalid CAIP-2 with unknown simple name returns error without fix
- validateAsset: known asset on known network returns no issues
- validateAsset: unknown asset returns UNKNOWN_ASSET warning
- validateAsset: missing asset returns no issues (handled by fields)
- Network with correct CAIP-2 format but empty reference rejected

**amount.test.ts** (~16 tests):
- Missing amount returns no issues (handled by fields)
- Valid numeric string '1000000' returns no issues
- Zero amount '0' returns ZERO_AMOUNT error
- Decimal amount '10.5' returns INVALID_AMOUNT error
- Negative amount '-100' returns INVALID_AMOUNT error
- Scientific notation '1e6' returns INVALID_AMOUNT error
- Non-numeric 'abc' returns INVALID_AMOUNT error
- Very large number (20+ digits) returns no issues
- Empty string returns no issues (handled by fields)
- Amount with spaces '100 000' returns INVALID_AMOUNT error
- **validateTimeout: v2 entry without maxTimeoutSeconds returns MISSING_MAX_TIMEOUT warning**
- **validateTimeout: v2 entry with maxTimeoutSeconds:300 (valid positive integer) returns no issues**
- **validateTimeout: entry with maxTimeoutSeconds:'300' (string, not number) returns INVALID_TIMEOUT error**
- **validateTimeout: entry with maxTimeoutSeconds:0 returns INVALID_TIMEOUT error**
- **validateTimeout: entry with maxTimeoutSeconds:-5 returns INVALID_TIMEOUT error**
- **validateTimeout: entry with maxTimeoutSeconds:3.5 (float, not integer) returns INVALID_TIMEOUT error**

**legacy.test.ts** (~6 tests):
- flat-legacy format returns LEGACY_FORMAT warning with upgrade fix
- v1 format returns LEGACY_FORMAT warning with v2 upgrade fix
- v2 format returns no legacy warnings
- LEGACY_FORMAT warning has field '$'
- fix suggestion for flat-legacy mentions 'accepts[] array'
- fix suggestion for v1 mentions 'amount instead of maxAmountRequired'

Target: ~60 unit tests across 6 files.
  </action>
  <verify>
Run `cd /Users/rawgroundbeef/Projects/x402lint && npx vitest run --reporter=verbose 2>&1 | grep -c 'PASS\|✓\|pass'` to count passing tests. All rule unit tests pass.
  </verify>
  <done>
7 JSON fixture files created. 6 rule unit test files with ~60 tests total, all passing. Every error code from structure, version, fields, network, amount, legacy, and the new INVALID_URL and INVALID_TIMEOUT codes are exercised.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create orchestrator and integration tests to reach 100+ total</name>
  <files>
    packages/x402lint/test/validation/orchestrator.test.ts
    packages/x402lint/test/integration.test.ts
  </files>
  <action>
**orchestrator.test.ts** (~40 tests) - Tests validate() end-to-end through the pipeline:

```
describe('validate()', () => {
  describe('Level 1: Structure', () => {
    - 'not json' string returns valid:false, INVALID_JSON, version:'unknown', normalized:null
    - '42' returns valid:false, NOT_OBJECT
    - '[]' returns valid:false, NOT_OBJECT
    - 'null' returns valid:false, NOT_OBJECT
    - '{}' returns valid:false, UNKNOWN_FORMAT
    - object input (not string) works identically
  })

  describe('Level 2: Version and shape', () => {
    - Valid v2 config returns valid:true, version:'v2'
    - Valid v1 config returns valid:true, version:'v1' (normalized to v2)
    - Flat-legacy config returns valid:true (if fields valid), version:'flat-legacy'
    - Config with accepts:[] returns EMPTY_ACCEPTS
    - v2 config without resource returns warning MISSING_RESOURCE
    - v2 config with x402Version:3 accepted by detection? (detect checks x402Version===2 for v2, so x402Version:3 + accepts = unknown format)
  })

  describe('Level 3: Field validation', () => {
    - v2 config missing scheme in accepts[0] returns MISSING_SCHEME
    - v2 config missing network returns MISSING_NETWORK
    - v2 config missing amount returns MISSING_AMOUNT
    - v2 config missing asset returns MISSING_ASSET
    - v2 config missing payTo returns MISSING_PAY_TO
    - v2 config with multiple accepts entries validates each
    - Errors include correct field paths (accepts[0].scheme, accepts[1].network, etc.)
  })

  describe('Level 4: Network and amount', () => {
    - Network 'base' in v2 accepts (if somehow present post-normalization, or test network validation rule directly) -- actually normalization doesn't fix v2 network fields (only flat-legacy). So a v2 config with network:'base' will pass detection as v2 but fail INVALID_NETWORK_FORMAT with fix suggestion.
    - Valid CAIP-2 unknown network returns UNKNOWN_NETWORK warning
    - Amount '0' returns ZERO_AMOUNT error
    - Amount 'abc' returns INVALID_AMOUNT error
    - Amount '1000000' with valid config returns valid:true
    - v2 entry without maxTimeoutSeconds returns MISSING_MAX_TIMEOUT warning
    - **v2 entry with maxTimeoutSeconds:'not-a-number' returns INVALID_TIMEOUT error**
    - **v2 entry with maxTimeoutSeconds:0 returns INVALID_TIMEOUT error**
    - **v2 config with resource.url 'not://valid' returns INVALID_URL warning**
  })

  describe('Level 4: Address validation', () => {
    - Valid EVM checksummed address returns no address errors
    - All-lowercase EVM address returns NO_EVM_CHECKSUM warning
    - Bad EVM checksum returns BAD_EVM_CHECKSUM warning
    - Invalid EVM address format returns INVALID_EVM_ADDRESS error
    - Valid Solana address returns no issues
    - Invalid Solana address returns INVALID_SOLANA_ADDRESS error
  })

  describe('Level 5: Legacy warnings', () => {
    - Flat-legacy config returns LEGACY_FORMAT warning
    - v1 config returns LEGACY_FORMAT warning
    - v2 config returns no LEGACY_FORMAT warnings
  })

  describe('Strict mode', () => {
    - Config with warnings only: lenient returns valid:true, strict returns valid:false
    - Strict mode moves all warnings to errors array
    - Strict mode clears warnings array
    - Strict mode with no warnings returns valid:true
    - Strict mode with errors AND warnings returns both in errors
  })

  describe('Edge cases', () => {
    - null input (if somehow passed) doesn't throw
    - undefined input doesn't throw
    - Very large config with many accepts entries works
    - Config with extra/extensions fields preserved in normalized output
  })
})
```

**integration.test.ts** (~20 tests) - JSON fixtures and round-trips:

```
describe('fixture-based tests', () => {
  - valid-v2-base.json passes validation (valid:true, version:'v2')
  - valid-v2-solana.json passes validation
  - valid-v1.json passes with normalization (normalized.x402Version === 2)
  - valid-flat.json passes with legacy warnings
  - invalid-no-accepts.json fails validation
  - invalid-bad-network.json fails with INVALID_NETWORK_FORMAT
  - real-world/coinbase-x402-sample.json passes validation
  - JSON string fixture: JSON.stringify(fixture) validates identically to object
})

describe('round-trip validation', () => {
  - Flat config -> normalize -> validate = valid:true, no legacy warnings (normalized is v2)
  - v1 config -> normalize -> validate = valid:true, no legacy warnings
  - v2 config -> normalize -> validate = valid:true (passthrough)
  - Normalized output has x402Version:2 for all input formats
})

describe('error code coverage', () => {
  - Test that exercises EVERY ErrorCode value (iterate over ErrorCode keys, verify each has been produced in at least one test)
  - This can be a meta-test that collects all error codes produced across all test runs, or simply a commented checklist. Prefer: a test that validates each error code is reachable by constructing the minimal input that triggers it.
  - **Must include INVALID_URL (malformed resource URL) and INVALID_TIMEOUT (non-positive-integer timeout)**
})

describe('validate() API contract', () => {
  - Return type always has: valid (boolean), version (string), errors (array), warnings (array), normalized (object|null)
  - errors array contains only severity:'error' issues
  - warnings array contains only severity:'warning' issues
  - normalized is null only when valid is false due to structure errors
  - version is never undefined
})
```

Import fixtures using: `import validV2Base from '../fixtures/valid-v2-base.json'` (vitest supports JSON imports).

If JSON imports don't work with the current tsconfig, use `JSON.parse(readFileSync(...))` from `node:fs`. Check if `resolveJsonModule` is enabled in tsconfig; if not, use fs.readFileSync approach.

**Target: combined with Task 1's ~60 unit tests, reach 100+ total.**
Count tests by running: `npx vitest run --reporter=verbose 2>&1 | tail -5` which shows total test count.
  </action>
  <verify>
Run `cd /Users/rawgroundbeef/Projects/x402lint && npx vitest run` -- all tests pass with zero failures. Run `npx vitest run --reporter=verbose 2>&1 | grep -c '✓'` to verify 100+ test cases. If under 100, add more edge cases to orchestrator.test.ts.
  </verify>
  <done>
100+ test cases pass. Every ErrorCode is exercised including INVALID_URL and INVALID_TIMEOUT. JSON fixtures load and validate correctly. Round-trip tests (normalize then validate) pass. Strict mode tests confirm warning promotion. Full integration coverage of the validate() pipeline.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/rawgroundbeef/Projects/x402lint && npx vitest run` -- all tests pass, zero failures
2. Test count >= 100 (verified via verbose output)
3. Every ErrorCode constant appears in at least one test assertion (including INVALID_URL and INVALID_TIMEOUT)
4. JSON fixture files are valid JSON (parseable)
5. Round-trip tests confirm normalize -> validate produces valid:true
6. Strict mode tests confirm warning -> error promotion
</verification>

<success_criteria>
- 100+ test cases pass with zero failures
- Every ErrorCode has at least one test producing it, including INVALID_URL and INVALID_TIMEOUT
- JSON fixtures cover v2, v1, flat-legacy, invalid configs, and real-world samples
- Round-trip normalize -> validate confirms idempotent validation
- Strict mode correctly promotes warnings to errors
- Integration tests exercise the full validate() pipeline end-to-end
- URL format validation tested with valid URLs, malformed URLs, and empty URLs
- Timeout value validation tested with valid integers, strings, zero, negatives, and floats
</success_criteria>

<output>
After completion, create `.planning/phases/08-validation-rules-and-orchestrator/08-03-SUMMARY.md`
</output>
