---
phase: 13-manifest-validation
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - packages/x402lint/test/manifest-validation.test.ts
  - packages/x402lint/test/integration.test.ts
autonomous: true

must_haves:
  truths:
    - "validateManifest() with valid multi-endpoint manifest returns valid:true"
    - "validateManifest() with invalid endpoint returns valid:false with prefixed field paths"
    - "Duplicate endpoint URLs produce DUPLICATE_ENDPOINT_URL warning"
    - "Mixed mainnet+testnet networks produce MIXED_NETWORKS warning"
    - "Duplicate bazaar routes produce DUPLICATE_BAZAAR_ROUTE warning"
    - "GET endpoint with body input produces BAZAAR_GET_WITH_BODY error"
    - "POST endpoint with queryParams input produces BAZAAR_POST_WITH_QUERY_PARAMS error"
    - "Empty endpoints returns valid:true with zero issues"
    - "Warnings do not affect the valid flag"
    - "All error codes are exercised by at least one test (integration coverage)"
  artifacts:
    - path: "packages/x402lint/test/manifest-validation.test.ts"
      provides: "Comprehensive test suite for validateManifest"
      min_lines: 200
    - path: "packages/x402lint/test/integration.test.ts"
      provides: "Updated error code coverage to exercise new manifest validation codes"
  key_links:
    - from: "packages/x402lint/test/manifest-validation.test.ts"
      to: "packages/x402lint/src/validation/manifest.ts"
      via: "import { validateManifest }"
      pattern: "import.*validateManifest"
    - from: "packages/x402lint/test/integration.test.ts"
      to: "packages/x402lint/src/types/errors.ts"
      via: "exercises all ErrorCode values including new manifest codes"
      pattern: "DUPLICATE_ENDPOINT_URL|MIXED_NETWORKS|DUPLICATE_BAZAAR_ROUTE"
---

<objective>
Create comprehensive test coverage for validateManifest() including per-endpoint validation, cross-endpoint checks, bazaar method discrimination, edge cases, and update the integration test to exercise all new error codes.

Purpose: Ensure the manifest validation function works correctly for all scenarios and that new error codes are covered in the integration test's exhaustive ErrorCode coverage check.

Output: New test file with 30+ test cases covering all validateManifest behaviors, updated integration test.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-manifest-validation/13-CONTEXT.md
@.planning/phases/13-manifest-validation/13-RESEARCH.md
@.planning/phases/13-manifest-validation/13-01-SUMMARY.md

Key files to reference:
@packages/x402lint/src/validation/manifest.ts
@packages/x402lint/src/types/manifest.ts
@packages/x402lint/src/types/errors.ts
@packages/x402lint/test/manifest.test.ts (existing manifest detection tests -- follow same patterns)
@packages/x402lint/test/integration.test.ts
@packages/x402lint/test/validation/orchestrator.test.ts (follow testing patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive validateManifest test suite</name>
  <files>
    packages/x402lint/test/manifest-validation.test.ts
  </files>
  <action>
    Create `test/manifest-validation.test.ts` with comprehensive tests for `validateManifest()`. Follow the same patterns as existing test files (vitest, describe/it/expect, helper functions for building test data).

    **Helper at top of file:**
    ```typescript
    import { describe, it, expect } from 'vitest'
    import { validateManifest } from '../src/index'
    import type { ManifestConfig, V2Config } from '../src/index'

    function makeEndpoint(overrides?: Partial<V2Config>): V2Config {
      return {
        x402Version: 2,
        accepts: [{
          scheme: 'exact',
          network: 'eip155:8453',
          amount: '100',
          asset: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913',
          payTo: '0x5aAeb6053F3E94C9b9A09f33669435E7Ef1BeAed',
          maxTimeoutSeconds: 60,
        }],
        resource: { url: 'https://example.com/api' },
        ...overrides,
      }
    }

    function makeManifest(endpoints: Record<string, V2Config>, extras?: Partial<ManifestConfig>): ManifestConfig {
      return { endpoints, ...extras }
    }
    ```

    Use valid EVM addresses with correct checksums (0x5aAeb6053F3E94C9b9A09f33669435E7Ef1BeAed and 0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913) so per-endpoint validation passes cleanly.

    **Test groups (use `describe` blocks):**

    **1. "basic validation" (5-6 tests):**
    - Single valid endpoint returns valid:true, endpointResults has 1 entry
    - Multiple valid endpoints returns valid:true, endpointResults has correct count
    - Empty endpoints ({}) returns valid:true, empty endpointResults, no errors/warnings
    - Result includes normalized field equal to input manifest
    - Result has correct structure (valid, errors, warnings, endpointResults, normalized)

    **2. "per-endpoint validation" (5-6 tests):**
    - Invalid endpoint (missing required fields) returns valid:false
    - Error field paths are prefixed with `endpoints["endpointId"].` (check a specific error's field property)
    - Root-level field path ($) is transformed to `endpoints["endpointId"]` (test with a config that triggers $ field path)
    - Multiple endpoints where one fails: valid:false, failing endpoint has errors, passing endpoint is valid
    - Per-endpoint warnings are preserved with correct field path prefix

    **3. "cross-endpoint checks" (6-7 tests):**
    - Duplicate resource URLs produce DUPLICATE_ENDPOINT_URL warning (create 2 endpoints with same resource.url)
    - Non-duplicate URLs produce no warning
    - Mixed networks (one mainnet eip155:8453, one testnet eip155:84532) produce MIXED_NETWORKS warning
    - Same network across endpoints: no MIXED_NETWORKS warning
    - Unknown networks (not in registry) do NOT trigger MIXED_NETWORKS (use e.g., eip155:999999)
    - Duplicate bazaar routes (same method+URL on 2 endpoints) produce DUPLICATE_BAZAAR_ROUTE warning
    - Cross-endpoint warnings do NOT affect valid flag (valid:true despite warnings)

    **4. "bazaar method discrimination" (8-10 tests):**
    - GET endpoint with body input shape: BAZAAR_GET_WITH_BODY error
    - GET endpoint without queryParams: BAZAAR_GET_MISSING_QUERY_PARAMS error
    - GET endpoint with queryParams and no body: no bazaar errors
    - POST endpoint with queryParams input shape: BAZAAR_POST_WITH_QUERY_PARAMS error
    - POST endpoint without body: BAZAAR_POST_MISSING_BODY error
    - POST endpoint with body and no queryParams: no bazaar errors
    - PUT/PATCH/DELETE follow same rules as POST (test at least one, e.g., PUT with queryParams = error)
    - Endpoint without bazaar extension: no bazaar errors (bazaar is optional)
    - Bazaar errors make valid:false (they are errors, not warnings)

    For bazaar tests, create endpoints with extensions.bazaar.info.input like:
    ```typescript
    makeEndpoint({
      extensions: {
        bazaar: {
          info: {
            input: {
              type: 'application/json',
              method: 'GET',
              body: { type: 'object' }  // error: GET with body
            },
            output: { type: 'application/json' }
          },
          schema: { type: 'object', properties: {} }
        }
      }
    })
    ```

    **5. "edge cases" (3-4 tests):**
    - Manifest with service metadata: validates normally (metadata doesn't affect validation)
    - Single endpoint with all warnings but no errors: valid:true
    - Endpoint ID with special characters (dots, spaces): field path uses bracket notation correctly
    - Large manifest (10+ endpoints, all valid): valid:true, correct endpointResults count

    Target: 30+ test cases total.
  </action>
  <verify>
    Run `cd /Users/rawgroundbeef/Projects/x402lint && pnpm --filter x402lint test` -- all tests pass including new manifest-validation.test.ts
  </verify>
  <done>
    manifest-validation.test.ts has 30+ test cases covering basic validation, per-endpoint validation with field path prefixing, all cross-endpoint checks (duplicate URLs, mixed networks, duplicate bazaar routes), all bazaar method discrimination scenarios (GET/POST/PUT/PATCH/DELETE), and edge cases. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update integration test error code coverage</name>
  <files>
    packages/x402lint/test/integration.test.ts
  </files>
  <action>
    Update the `exercises EVERY ErrorCode value` test in `test/integration.test.ts` to cover the new manifest validation error codes.

    The test currently has an `expectedUnreachableFromPipeline` array that lists error codes not exercised by `validate()`. The new manifest codes (DUPLICATE_ENDPOINT_URL, MIXED_NETWORKS, DUPLICATE_BAZAAR_ROUTE, BAZAAR_GET_WITH_BODY, BAZAAR_GET_MISSING_QUERY_PARAMS, BAZAAR_POST_WITH_QUERY_PARAMS, BAZAAR_POST_MISSING_BODY) need to be handled.

    **Approach:** Add these new codes to the `expectedUnreachableFromPipeline` array with a comment explaining they are exercised by `manifest-validation.test.ts` (not by the single-config validate() pipeline). This is the correct pattern since this specific test is about validate() coverage, and manifest codes are tested in their own test file.

    Add to the expectedUnreachableFromPipeline array:
    ```typescript
    // Manifest cross-endpoint and bazaar codes (exercised in manifest-validation.test.ts)
    'DUPLICATE_ENDPOINT_URL',
    'MIXED_NETWORKS',
    'DUPLICATE_BAZAAR_ROUTE',
    'BAZAAR_GET_WITH_BODY',
    'BAZAAR_GET_MISSING_QUERY_PARAMS',
    'BAZAAR_POST_WITH_QUERY_PARAMS',
    'BAZAAR_POST_MISSING_BODY',
    ```

    This ensures the integration test doesn't fail due to new error codes that are only reachable through validateManifest(), not validate().
  </action>
  <verify>
    Run `cd /Users/rawgroundbeef/Projects/x402lint && pnpm --filter x402lint test` -- all tests pass including the updated integration test
  </verify>
  <done>
    Integration test's exhaustive ErrorCode coverage check accounts for all 7 new manifest validation codes. No test failures. Total test count increased by 30+ from manifest-validation.test.ts.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter x402lint test` passes all tests (existing + new)
2. manifest-validation.test.ts has 30+ test cases
3. Integration test accounts for all new error codes
4. No test file touches source code (tests are read-only consumers)
5. Test patterns match existing codebase conventions (vitest, describe/it/expect)
</verification>

<success_criteria>
- All validateManifest behaviors have test coverage
- Per-endpoint field path prefixing verified by tests
- Every cross-endpoint check (duplicate URLs, mixed networks, duplicate bazaar routes) has passing tests
- Every bazaar method discrimination rule (GET/POST/PUT/PATCH/DELETE) has passing tests
- Empty manifest and edge cases covered
- Integration test accounts for 7 new error codes
- Zero test failures across entire test suite
</success_criteria>

<output>
After completion, create `.planning/phases/13-manifest-validation/13-02-SUMMARY.md`
</output>
