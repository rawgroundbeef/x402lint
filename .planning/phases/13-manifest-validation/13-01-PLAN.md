---
phase: 13-manifest-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/x402lint/src/types/manifest.ts
  - packages/x402lint/src/types/errors.ts
  - packages/x402lint/src/validation/manifest.ts
  - packages/x402lint/src/validation/index.ts
  - packages/x402lint/src/index.ts
autonomous: true

must_haves:
  truths:
    - "validateManifest() returns ManifestValidationResult with per-endpoint results and manifest-level issues"
    - "Each endpoint is validated through existing validate() pipeline with field paths prefixed by endpoint ID"
    - "Cross-endpoint checks detect duplicate URLs (warning), mixed networks (warning), and duplicate bazaar routes (warning)"
    - "Bazaar method discrimination produces errors for GET with body, POST with queryParams, etc."
    - "Empty endpoints ({}) returns valid:true with zero issues"
    - "Top-level valid is true only when ALL endpoints pass AND no manifest-level errors exist"
    - "validateManifest is importable from x402lint package"
  artifacts:
    - path: "packages/x402lint/src/validation/manifest.ts"
      provides: "validateManifest function with cross-endpoint checks and bazaar discrimination"
      min_lines: 100
    - path: "packages/x402lint/src/types/manifest.ts"
      provides: "ManifestValidationResult with Record (not Map)"
      contains: "Record<string, ValidationResult>"
    - path: "packages/x402lint/src/types/errors.ts"
      provides: "New manifest validation error codes"
      contains: "DUPLICATE_ENDPOINT_URL"
  key_links:
    - from: "packages/x402lint/src/validation/manifest.ts"
      to: "packages/x402lint/src/validation/orchestrator.ts"
      via: "import { validate }"
      pattern: "import.*validate.*from.*orchestrator"
    - from: "packages/x402lint/src/index.ts"
      to: "packages/x402lint/src/validation/manifest.ts"
      via: "re-export validateManifest"
      pattern: "validateManifest"
    - from: "packages/x402lint/src/validation/manifest.ts"
      to: "packages/x402lint/src/registries/networks.ts"
      via: "import getNetworkInfo for testnet detection"
      pattern: "getNetworkInfo|KNOWN_NETWORKS"
---

<objective>
Implement the validateManifest() function that validates entire x402 manifest configurations through per-endpoint validation, cross-endpoint consistency checks, and bazaar method discrimination.

Purpose: This is the core of Phase 13 -- developers need to validate multi-endpoint manifests with the same quality as single-config validation, plus cross-endpoint consistency checks that only manifests require.

Output: Working validateManifest() function exported from package public API, updated types (ManifestValidationResult uses Record not Map), and all new error codes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-manifest-validation/13-CONTEXT.md
@.planning/phases/13-manifest-validation/13-RESEARCH.md
@.planning/phases/11-manifest-types-detection/11-01-SUMMARY.md

Key existing files to reference:
@packages/x402lint/src/types/manifest.ts
@packages/x402lint/src/types/errors.ts
@packages/x402lint/src/types/validation.ts
@packages/x402lint/src/types/config.ts
@packages/x402lint/src/validation/orchestrator.ts
@packages/x402lint/src/validation/index.ts
@packages/x402lint/src/validation/rules/extensions.ts
@packages/x402lint/src/registries/networks.ts
@packages/x402lint/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ManifestValidationResult type and add manifest validation error codes</name>
  <files>
    packages/x402lint/src/types/manifest.ts
    packages/x402lint/src/types/errors.ts
  </files>
  <action>
    **In `src/types/manifest.ts`:**

    1. Change `ManifestValidationResult.endpointResults` from `Map<string, ValidationResult>` to `Record<string, ValidationResult>` (per CONTEXT.md and RESEARCH.md -- Record serializes to JSON directly, no `.toJSON()` needed).

    2. Add a `normalized: ManifestConfig` field to `ManifestValidationResult` (per CONTEXT.md decision: "Include the normalized manifest in the result so callers don't need to call normalize() separately").

    The final interface should be:
    ```typescript
    export interface ManifestValidationResult {
      valid: boolean
      errors: ValidationIssue[]
      warnings: ValidationIssue[]
      endpointResults: Record<string, ValidationResult>
      normalized: ManifestConfig
    }
    ```

    **In `src/types/errors.ts`:**

    Add these new error codes to the `ErrorCode` object (in a "Manifest validation (Phase 13)" section after the existing manifest errors section):
    - `DUPLICATE_ENDPOINT_URL: 'DUPLICATE_ENDPOINT_URL'`
    - `MIXED_NETWORKS: 'MIXED_NETWORKS'`
    - `DUPLICATE_BAZAAR_ROUTE: 'DUPLICATE_BAZAAR_ROUTE'`
    - `BAZAAR_GET_WITH_BODY: 'BAZAAR_GET_WITH_BODY'`
    - `BAZAAR_GET_MISSING_QUERY_PARAMS: 'BAZAAR_GET_MISSING_QUERY_PARAMS'`
    - `BAZAAR_POST_WITH_QUERY_PARAMS: 'BAZAAR_POST_WITH_QUERY_PARAMS'`
    - `BAZAAR_POST_MISSING_BODY: 'BAZAAR_POST_MISSING_BODY'`

    Add corresponding messages to `ErrorMessages`:
    - `DUPLICATE_ENDPOINT_URL: 'Multiple endpoints share the same URL'`
    - `MIXED_NETWORKS: 'Manifest contains both mainnet and testnet networks'`
    - `DUPLICATE_BAZAAR_ROUTE: 'Multiple endpoints share the same HTTP method + path'`
    - `BAZAAR_GET_WITH_BODY: 'GET requests cannot have body input shape'`
    - `BAZAAR_GET_MISSING_QUERY_PARAMS: 'GET requests should define queryParams input shape'`
    - `BAZAAR_POST_WITH_QUERY_PARAMS: 'POST/PUT/PATCH/DELETE requests should not use queryParams input shape'`
    - `BAZAAR_POST_MISSING_BODY: 'POST/PUT/PATCH/DELETE requests should define body input shape'`

    IMPORTANT: Keep the existing manifest error codes (MISSING_ENDPOINTS, INVALID_ENDPOINTS, etc.) in their current position. Add the new ones in a NEW section below.
  </action>
  <verify>
    Run `cd /Users/rawgroundbeef/Projects/x402lint && pnpm exec tsc --noEmit -p packages/x402lint/tsconfig.json` to verify TypeScript compiles without errors. The `ErrorMessages satisfies Record<ErrorCode, string>` will catch any missing message entries.
  </verify>
  <done>
    ManifestValidationResult uses Record (not Map), includes normalized field. Seven new manifest validation error codes exist with messages. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement validateManifest() with per-endpoint validation, cross-endpoint checks, and bazaar discrimination</name>
  <files>
    packages/x402lint/src/validation/manifest.ts
    packages/x402lint/src/validation/index.ts
    packages/x402lint/src/index.ts
  </files>
  <action>
    **Create `src/validation/manifest.ts`:**

    Implement `validateManifest(input: ManifestConfig): ManifestValidationResult` following the composition pattern from RESEARCH.md. The function must:

    **1. Per-endpoint validation:**
    - Iterate `Object.entries(input.endpoints)` (handle empty endpoints `{}` -- return valid result with zero endpoint results, per Phase 11 decision)
    - Call `validate(endpointConfig)` for each endpoint (import from `./orchestrator`)
    - Prefix all field paths in the returned ValidationResult with `endpoints["${endpointId}"].` using bracket notation
    - For root-level field paths (`$`), transform to `endpoints["${endpointId}"]` (no trailing dot)
    - Store results in `Record<string, ValidationResult>`

    **2. Cross-endpoint consistency checks (all performed on the manifest as a whole):**

    a) **Duplicate endpoint URLs (warning):** Build a Map of resource.url -> count. For any URL appearing more than once, emit a warning with code `DUPLICATE_ENDPOINT_URL`, field `endpoints`, and fix suggestion.

    b) **Mixed networks (warning):** Collect all networks from all accepts entries across all endpoints. Use `getNetworkInfo()` from `../../registries/networks` to check `testnet` field. If both testnet and non-testnet networks appear, emit warning with code `MIXED_NETWORKS`. For unknown networks (not in registry), skip them in this check (don't false-positive). Only warn when there's a clear mix of KNOWN mainnet and KNOWN testnet networks.

    c) **Duplicate bazaar route (warning -- per CONTEXT.md decision, this is a warning not error):** For endpoints with `extensions.bazaar.info.input.method`, build route key as `${method.toUpperCase()} ${resource.url}`. If same route appears on multiple endpoints, emit warning with code `DUPLICATE_BAZAAR_ROUTE`.

    NOTE: ROADMAP SC3 originally included "inconsistent payTo addresses across endpoints (warning)" as a cross-endpoint check. This was intentionally refined during the discuss phase -- CONTEXT.md states "Same payTo address across endpoints is expected (single merchant) -- no warning." The payTo consistency check is therefore intentionally omitted. This is a user decision override, not a gap.

    **3. Bazaar method discrimination (errors -- per CONTEXT.md decision):**

    Implement a private helper `validateBazaarMethodDiscrimination(endpoint: V2Config, endpointId: string): ValidationIssue[]` that:
    For each endpoint with `extensions.bazaar.info.input`:
    - Extract `method` from `input.method` (case-insensitive, normalize to uppercase)
    - If method is `GET`:
      - If `input.body` is present (not undefined): error `BAZAAR_GET_WITH_BODY` with field `endpoints["${id}"].extensions.bazaar.info.input.body`
      - If `input.queryParams` is absent (undefined): error `BAZAAR_GET_MISSING_QUERY_PARAMS` with field `endpoints["${id}"].extensions.bazaar.info.input.queryParams`
    - If method is `POST`, `PUT`, `PATCH`, or `DELETE`:
      - If `input.queryParams` is present: error `BAZAAR_POST_WITH_QUERY_PARAMS` with field `endpoints["${id}"].extensions.bazaar.info.input.queryParams`
      - If `input.body` is absent: error `BAZAAR_POST_MISSING_BODY` with field `endpoints["${id}"].extensions.bazaar.info.input.body`
    - Returns an array of ValidationIssue objects (severity 'error' for all bazaar discrimination issues)

    **Wiring into validateManifest:** In the main `validateManifest` function body, AFTER the cross-endpoint checks loop (step 2), iterate all endpoints again. For each endpoint, call `validateBazaarMethodDiscrimination(endpointConfig, endpointId)` and push all returned issues into `manifestErrors` (all bazaar discrimination issues are severity=error per CONTEXT.md decision). Do NOT put bazaar issues into per-endpoint results -- they are manifest-level concerns about the bazaar extension.

    **4. Aggregate result:**
    ```typescript
    const allEndpointsValid = Object.values(endpointResults).every(r => r.valid)
    const noManifestErrors = manifestErrors.length === 0
    const valid = allEndpointsValid && noManifestErrors
    ```
    Warnings do NOT affect the valid flag (per CONTEXT.md and Pitfall 6 from RESEARCH.md).

    Return `{ valid, errors: manifestErrors, warnings: manifestWarnings, endpointResults, normalized: input }`

    **Helper functions to implement (all private/unexported):**
    - `prefixFieldPaths(result: ValidationResult, endpointId: string): ValidationResult`
    - `performCrossEndpointChecks(manifest: ManifestConfig): { errors: ValidationIssue[], warnings: ValidationIssue[] }`
    - `validateBazaarMethodDiscrimination(endpoint: V2Config, endpointId: string): ValidationIssue[]`

    Use fix suggestions that match existing v2 style -- actionable, specific (per RESEARCH.md Open Question 4).

    **In `src/validation/index.ts`:**
    Add: `export { validateManifest } from './manifest'`

    **In `src/index.ts`:**
    Add manifest validation export near the existing validation exports:
    ```typescript
    // Re-export manifest validation (Phase 13)
    export { validateManifest } from './validation'
    export type { ManifestValidationResult } from './types'
    ```

    IMPORTANT NOTES:
    - Do NOT reimplement any validation rules from validate() -- composition only
    - Do NOT add Ajv or any deep JSON Schema parsing
    - Do NOT mutate the input manifest
    - Access bazaar extension fields via bracket notation and runtime checks (`as Record<string, unknown>`) since extension types are Record<string, unknown>
    - The function must NEVER throw -- wrap in try/catch like validate() does
  </action>
  <verify>
    1. Run `cd /Users/rawgroundbeef/Projects/x402lint && pnpm exec tsc --noEmit -p packages/x402lint/tsconfig.json` -- must compile cleanly
    2. Run `cd /Users/rawgroundbeef/Projects/x402lint && pnpm --filter x402lint test` -- all existing tests must pass (no regressions)
    3. Run `cd /Users/rawgroundbeef/Projects/x402lint && pnpm --filter x402lint build` -- build must succeed
    4. Smoke test bazaar discrimination: Run inline node script that validates a manifest containing a GET endpoint with a body input shape, and verify the result includes an error with code BAZAAR_GET_WITH_BODY. Example: `node -e "const { validateManifest } = require('./dist/index.cjs'); const r = validateManifest({ endpoints: { ep1: { x402Version: 2, accepts: [{ scheme: 'exact', network: 'eip155:8453', amount: '100', asset: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913', payTo: '0x5aAeb6053F3E94C9b9A09f33669435E7Ef1BeAed', maxTimeoutSeconds: 60 }], resource: { url: 'https://example.com/api' }, extensions: { bazaar: { info: { input: { type: 'application/json', method: 'GET', body: { type: 'object' } }, output: { type: 'application/json' } }, schema: { type: 'object' } } } } } }); console.log(JSON.stringify(r.errors.map(e => e.code))); if (!r.errors.some(e => e.code === 'BAZAAR_GET_WITH_BODY')) { process.exit(1); }"` (run from packages/x402lint/ after build)
  </verify>
  <done>
    validateManifest() exists, is exported from package public API, compiles cleanly, all existing tests pass. The function validates per-endpoint via validate(), prefixes field paths, performs cross-endpoint checks, and validates bazaar method discrimination. Bazaar discrimination is explicitly wired into the main function via iteration after cross-endpoint checks. Smoke test confirms BAZAAR_GET_WITH_BODY detection works end-to-end.
  </done>
</task>

</tasks>

<verification>
1. `pnpm exec tsc --noEmit -p packages/x402lint/tsconfig.json` compiles with zero errors
2. `pnpm --filter x402lint test` passes all existing tests (no regressions from type/error code changes)
3. `pnpm --filter x402lint build` succeeds
4. `validateManifest` is importable: `import { validateManifest } from 'x402lint'`
5. ManifestValidationResult uses Record (not Map) for endpointResults
6. Seven new error codes exist in ErrorCode enum with matching messages
</verification>

<success_criteria>
- validateManifest() returns ManifestValidationResult with correct structure
- Per-endpoint validation delegates to existing validate() pipeline
- Field paths are prefixed with `endpoints["id"].` bracket notation
- Cross-endpoint checks detect: duplicate URLs (warning), mixed networks (warning), duplicate bazaar routes (warning)
- payTo consistency check intentionally omitted per CONTEXT.md user decision (ROADMAP SC3 refinement)
- Bazaar method discrimination: GET+body=error, GET-queryParams=error, POST+queryParams=error, POST-body=error
- Bazaar discrimination is wired into validateManifest via explicit iteration after cross-endpoint checks
- Empty manifest ({endpoints: {}}) returns valid:true
- Top-level valid = allEndpointsValid AND noManifestErrors (warnings ignored)
- Zero new runtime dependencies
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-manifest-validation/13-01-SUMMARY.md`
</output>
