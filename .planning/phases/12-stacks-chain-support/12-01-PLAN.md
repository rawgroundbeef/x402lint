---
phase: 12-stacks-chain-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/x402lint/package.json
  - packages/x402lint/src/crypto/c32check.ts
  - packages/x402lint/src/crypto/index.ts
  - packages/x402lint/src/types/errors.ts
  - packages/x402lint/src/registries/networks.ts
  - packages/x402lint/src/registries/simple-names.ts
  - packages/x402lint/src/validation/stacks-address.ts
  - packages/x402lint/src/validation/address.ts
  - packages/x402lint/test/validation/stacks-address.test.ts
  - packages/x402lint/test/validation/address.test.ts
autonomous: true

must_haves:
  truths:
    - "Stacks mainnet addresses (SP/SM prefix) pass validation when paired with stacks:1 network"
    - "Stacks testnet addresses (ST/SN prefix) pass validation when paired with stacks:2147483648 network"
    - "Invalid c32check checksums produce an error with actionable fix suggestion"
    - "Mainnet address on testnet network (and vice versa) produces an error identifying the mismatch"
    - "Human-readable network names (stacks:mainnet, stacks:testnet) are rejected with fix suggesting numeric form"
    - "Existing EVM and Solana validation still works (no regression)"
  artifacts:
    - path: "packages/x402lint/src/crypto/c32check.ts"
      provides: "c32check decode wrapper (matches base58.ts pattern)"
      contains: "decodeC32Address"
    - path: "packages/x402lint/src/validation/stacks-address.ts"
      provides: "Stacks address validation function"
      exports: ["validateStacksAddress"]
    - path: "packages/x402lint/src/registries/networks.ts"
      provides: "Stacks network entries in KNOWN_NETWORKS"
      contains: "stacks:1"
    - path: "packages/x402lint/test/validation/stacks-address.test.ts"
      provides: "Comprehensive Stacks address validation tests"
      min_lines: 80
  key_links:
    - from: "packages/x402lint/src/validation/address.ts"
      to: "packages/x402lint/src/validation/stacks-address.ts"
      via: "case 'stacks' in switch dispatch"
      pattern: "case 'stacks'"
    - from: "packages/x402lint/src/validation/stacks-address.ts"
      to: "packages/x402lint/src/crypto/c32check.ts"
      via: "import decodeC32Address"
      pattern: "decodeC32Address"
    - from: "packages/x402lint/src/registries/networks.ts"
      to: "stacks:1"
      via: "KNOWN_NETWORKS entry"
      pattern: "stacks:1.*Stacks Mainnet"
---

<objective>
Add Stacks blockchain address validation to x402lint, covering SP/SM (mainnet) and ST/SN (testnet) address prefixes with c32check checksum verification, network mismatch detection, and actionable error messages.

Purpose: Developers with Stacks-based x402 endpoints get address validation with the same depth as EVM and Solana chains (MAN-05).
Output: Working Stacks address validator integrated into the address dispatch pipeline, with comprehensive tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-stacks-chain-support/12-CONTEXT.md
@.planning/phases/12-stacks-chain-support/12-RESEARCH.md

# Existing patterns to follow exactly:
@packages/x402lint/src/validation/address.ts
@packages/x402lint/src/validation/solana-address.ts
@packages/x402lint/src/validation/evm-address.ts
@packages/x402lint/src/crypto/base58.ts
@packages/x402lint/src/crypto/index.ts
@packages/x402lint/src/registries/networks.ts
@packages/x402lint/src/registries/simple-names.ts
@packages/x402lint/src/types/errors.ts
@packages/x402lint/test/validation/solana-address.test.ts
@packages/x402lint/test/validation/address.test.ts
@packages/x402lint/package.json
@packages/x402lint/tsdown.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install c32check, add crypto wrapper, error codes, and registry entries</name>
  <files>
    packages/x402lint/package.json
    packages/x402lint/src/crypto/c32check.ts
    packages/x402lint/src/crypto/index.ts
    packages/x402lint/src/types/errors.ts
    packages/x402lint/src/registries/networks.ts
    packages/x402lint/src/registries/simple-names.ts
  </files>
  <action>
    1. Install c32check as a devDependency (same pattern as @noble/hashes and @scure/base -- tree-shaken into bundle, zero runtime deps):
       `pnpm add -D c32check --filter x402lint`

    2. Create `src/crypto/c32check.ts` following the exact pattern of `base58.ts`:
       - Import `c32addressDecode` from `c32check`
       - Export a `decodeC32Address(address: string): [number, string]` wrapper function
       - Wrap in try-catch, throw `Error('Invalid c32check encoding: ...')` on failure (matches base58.ts error pattern)
       - JSDoc comment matching base58.ts style

    3. Update `src/crypto/index.ts` barrel export:
       - Add `export { decodeC32Address } from './c32check'`

    4. Add error codes to `src/types/errors.ts`:
       - Add to ErrorCode const: `INVALID_STACKS_ADDRESS: 'INVALID_STACKS_ADDRESS'` and `STACKS_NETWORK_MISMATCH: 'STACKS_NETWORK_MISMATCH'`
       - Place them in the "Address errors" section, after INVALID_SOLANA_ADDRESS
       - Add to ErrorMessages:
         - `INVALID_STACKS_ADDRESS: 'Invalid Stacks address'`
         - `STACKS_NETWORK_MISMATCH: 'Stacks address does not match the specified network'`
       - Note: BAD_STACKS_CHECKSUM is NOT needed as a separate code. Invalid checksum is just one reason an address is invalid -- use INVALID_STACKS_ADDRESS with a specific message. This matches how Solana uses a single INVALID_SOLANA_ADDRESS code for all failure modes.

    5. Update `src/registries/networks.ts`:
       - Add `'stacks'` to the `NetworkType` union type: `export type NetworkType = 'evm' | 'solana' | 'stellar' | 'aptos' | 'stacks'`
       - Add Stacks entries to KNOWN_NETWORKS (after Solana entries):
         ```
         'stacks:1': { name: 'Stacks Mainnet', type: 'stacks', testnet: false },
         'stacks:2147483648': { name: 'Stacks Testnet', type: 'stacks', testnet: true },
         ```
       - IMPORTANT: The CAIP-2 reference `2147483648` is 10 characters long, which exceeds the current CAIP2_REGEX reference max of 32 chars. Verify this passes -- it's exactly 10 chars, well under the 32-char max, so it should be fine. If the regex has issues, the test in Task 2 will catch it.

    6. Update `src/registries/simple-names.ts`:
       - Add human-readable mappings (after Solana entries):
         ```
         stacks: 'stacks:1',
         'stacks-mainnet': 'stacks:1',
         'stacks-testnet': 'stacks:2147483648',
         ```
       - These enable fix suggestions when users write `stacks:mainnet` (which fails CAIP-2 since "mainnet" is alphabetic but the namespace + ref combo will fail validation, and the network rule will suggest the canonical form).
  </action>
  <verify>
    - `pnpm ls c32check --filter x402lint` shows c32check installed
    - `pnpm tsc --noEmit --project packages/x402lint` passes (no type errors)
    - No build errors: `pnpm build --filter x402lint` succeeds
  </verify>
  <done>
    c32check installed as devDependency, crypto wrapper exports decodeC32Address, error codes INVALID_STACKS_ADDRESS and STACKS_NETWORK_MISMATCH exist, Stacks networks in KNOWN_NETWORKS registry, simple name mappings for fix suggestions, all existing tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Stacks address validator, integrate into dispatcher, and write tests</name>
  <files>
    packages/x402lint/src/validation/stacks-address.ts
    packages/x402lint/src/validation/address.ts
    packages/x402lint/test/validation/stacks-address.test.ts
    packages/x402lint/test/validation/address.test.ts
  </files>
  <action>
    1. Create `src/validation/stacks-address.ts` following the exact pattern of `solana-address.ts`:

       ```typescript
       export function validateStacksAddress(
         address: string,
         network: string,
         field: string
       ): ValidationIssue[]
       ```

       Note: Unlike EVM/Solana validators, Stacks validator needs `network` parameter because version byte validation depends on whether it's mainnet or testnet.

       Implementation steps:
       a. Strip contract name suffix if present: if address contains '.', take only the part before the first dot (e.g., `SM123.my-contract` -> `SM123`). This handles full contract identifiers gracefully without erroring on the suffix.

       b. Quick format check with regex. Use a permissive pattern -- just check it starts with S followed by P, M, T, or N, then c32 characters. Don't be overly strict since c32addressDecode handles normalization (O->0, I->1, L->1). Something like: `/^S[PMTN][0-9A-HJ-NP-Z]{33,}$/i` -- but actually, because c32check handles normalization internally, just check the prefix and let c32addressDecode do the real validation. A minimal regex like `/^S[PMTN]/i` is sufficient as a quick gate. If it doesn't match, return error with code INVALID_STACKS_ADDRESS, message "Invalid Stacks address format", fix "Stacks addresses start with SP, SM, ST, or SN".

       c. Decode via `decodeC32Address(address)` from crypto wrapper. If throws, return error with code INVALID_STACKS_ADDRESS, message "Invalid Stacks address checksum. Double-check the address for typos.", severity 'error'. No fix needed (the message IS the fix).

       d. After successful decode, validate version byte against network:
          - Extract CAIP-2 reference from network string (split on ':', take index 1)
          - `stacks:1` (mainnet): expected version bytes are [22, 20] (SP=22, SM=20)
          - `stacks:2147483648` (testnet): expected version bytes are [26, 21] (ST=26, SN=21)
          - If version byte doesn't match expected for network, return error with code STACKS_NETWORK_MISMATCH.
          - For the message, determine what the address IS (mainnet or testnet based on actual version byte) and what was expected. E.g., "This is a Stacks mainnet address but the network is set to testnet (stacks:2147483648)". For the fix: "Use stacks:1 for mainnet addresses, or use a testnet address (ST/SN prefix)".
          - Map version bytes to human labels: 22/20 = "mainnet", 26/21 = "testnet". If unknown version byte (not 20, 21, 22, or 26), return INVALID_STACKS_ADDRESS with message "Unrecognized Stacks address version".

       e. If all checks pass, return empty array (valid).

       IMPORTANT constraints from CONTEXT.md:
       - Do NOT distinguish SP/ST from SM/SN in output -- just say "Stacks address"
       - Do NOT mention c32check, version bytes, or encoding in error messages
       - Do NOT add separate length validation (c32check handles it)
       - Accept both P2PKH and P2SH equally as valid payTo targets

    2. Update `src/validation/address.ts` dispatcher:
       - Import `validateStacksAddress` from `./stacks-address`
       - Add case to switch statement:
         ```
         case 'stacks':
           return validateStacksAddress(address, network, field)
         ```
       - Note: `validateStacksAddress` takes 3 params (address, network, field) unlike EVM/Solana which take 2 (address, field). This is because Stacks needs network context for version byte validation.

    3. Create `test/validation/stacks-address.test.ts` with comprehensive test coverage:

       Use REAL Stacks addresses for testing. Generate valid test addresses by checking the c32check README examples, or use well-known Stacks addresses. Some known addresses:
       - SP2J6ZY48GV1EZ5V2V5RB9MP66SW86PYKKNRV9EJ7 (mainnet standard, from c32check README)
       - SP000000000000000000002Q6VF78 (mainnet, Stacks genesis address)

       For testnet, use ST prefix addresses. The c32check library can generate these.

       Test groups (follow solana-address.test.ts structure):
       a. "valid Stacks addresses" -- SP mainnet standard, SM mainnet contract, ST testnet standard, SN testnet contract. Each validated against correct network.
       b. "invalid format" -- empty string, random gibberish, non-S prefix, wrong second char (SA, SB, etc.)
       c. "invalid checksum" -- valid-looking prefix but corrupted body (change a character in a known-good address)
       d. "network mismatch" -- SP address with stacks:2147483648 (testnet), ST address with stacks:1 (mainnet). Verify error code is STACKS_NETWORK_MISMATCH and message mentions the mismatch direction.
       e. "contract name handling" -- address with .contract-name suffix validates the base address correctly
       f. Each test asserts: issues length, severity, error code (from ErrorCode enum)

    4. Update `test/validation/address.test.ts`:
       - Add "Stacks addresses on Stacks networks" describe block (after Solana section):
         - Valid SP address on stacks:1 -> no issues
         - Valid ST address on stacks:2147483648 -> no issues
       - Add to "cross-chain mismatches":
         - Stacks address on EVM network -> fails with EVM error
         - EVM address on Stacks network -> fails with Stacks error

    5. Run full test suite and build:
       - `pnpm test --filter x402lint` -- all tests pass
       - `pnpm build --filter x402lint` -- build succeeds
       - Verify IIFE bundle size: `ls -la packages/x402lint/dist/index.global.js` -- should be under 45KB
  </action>
  <verify>
    - `pnpm test --filter x402lint` passes all tests (existing + new)
    - `pnpm build --filter x402lint` succeeds
    - IIFE bundle `packages/x402lint/dist/index.global.js` is under 45KB
    - `pnpm tsc --noEmit --project packages/x402lint` -- no type errors
  </verify>
  <done>
    validateStacksAddress correctly validates SP/SM on stacks:1 and ST/SN on stacks:2147483648. Invalid checksums produce clear error. Network mismatches produce specific error identifying direction. Address dispatcher routes stacks namespace to new validator. All 217+ existing tests still pass. New test file covers valid addresses, invalid format, invalid checksum, network mismatch, and contract name handling. Bundle size under 45KB.
  </done>
</task>

</tasks>

<verification>
1. `pnpm test --filter x402lint` -- all tests pass (existing + new Stacks tests)
2. `pnpm build --filter x402lint` -- clean build, no errors
3. `ls -la packages/x402lint/dist/index.global.js` -- under 45KB minified
4. `pnpm tsc --noEmit --project packages/x402lint` -- no TypeScript errors
</verification>

<success_criteria>
- SP and SM addresses pass validation when paired with stacks:1 network
- ST and SN addresses pass validation when paired with stacks:2147483648 network
- Invalid c32check checksums produce INVALID_STACKS_ADDRESS error with "Double-check the address" fix
- Mainnet address on testnet network produces STACKS_NETWORK_MISMATCH error identifying the mismatch
- Testnet address on mainnet network produces STACKS_NETWORK_MISMATCH error identifying the mismatch
- Human-readable "stacks:mainnet" / "stacks:testnet" rejected by CAIP-2 validation with fix suggestion to numeric form (via existing network validation + simple-names registry)
- All existing EVM and Solana tests pass unchanged
- IIFE bundle under 45KB
</success_criteria>

<output>
After completion, create `.planning/phases/12-stacks-chain-support/12-01-SUMMARY.md`
</output>
