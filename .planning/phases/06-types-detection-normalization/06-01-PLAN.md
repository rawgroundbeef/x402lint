---
phase: 06-types-detection-normalization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/x402lint/src/types/config.ts
  - packages/x402lint/src/types/validation.ts
  - packages/x402lint/src/types/errors.ts
  - packages/x402lint/src/types/index.ts
  - packages/x402lint/src/types/parse-input.ts
  - packages/x402lint/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Every error code constant (MISSING_SCHEME, INVALID_NETWORK_FORMAT, etc.) is exported from the package"
    - "Each error code has a human-readable message template and field path format"
    - "ValidationResult type has valid, errors, warnings, version, and normalized fields"
    - "Config types model v2, v1, and flat-legacy shapes with proper TypeScript types"
    - "parseInput utility accepts string | object and returns parsed unknown or error"
  artifacts:
    - path: "packages/x402lint/src/types/config.ts"
      provides: "V2Config, V1Config, FlatLegacyConfig, NormalizedConfig, ConfigFormat, AcceptsEntry types"
      contains: "x402Version"
    - path: "packages/x402lint/src/types/validation.ts"
      provides: "ValidationResult, ValidationIssue, Severity types"
      contains: "ValidationResult"
    - path: "packages/x402lint/src/types/errors.ts"
      provides: "ErrorCode const object, ErrorMessages record, all error/warning codes"
      contains: "as const"
    - path: "packages/x402lint/src/types/parse-input.ts"
      provides: "parseInput utility for string | object handling"
      contains: "JSON.parse"
    - path: "packages/x402lint/src/types/index.ts"
      provides: "Re-exports of all type modules"
    - path: "packages/x402lint/src/index.ts"
      provides: "Package entry point re-exporting types"
      contains: "export"
  key_links:
    - from: "packages/x402lint/src/types/index.ts"
      to: "packages/x402lint/src/types/config.ts"
      via: "re-export"
      pattern: "export.*from.*config"
    - from: "packages/x402lint/src/types/index.ts"
      to: "packages/x402lint/src/types/errors.ts"
      via: "re-export"
      pattern: "export.*from.*errors"
    - from: "packages/x402lint/src/index.ts"
      to: "packages/x402lint/src/types/index.ts"
      via: "re-export"
      pattern: "export.*from.*types"
---

<objective>
Create the complete type system, error vocabulary, and input parsing utility for the x402lint SDK.

Purpose: Every downstream module (detection, normalization, validation, registries) depends on these types and error codes. This is the foundation layer that all other Phase 6 plans build on.

Output: TypeScript type definitions for all x402 config formats, a complete error code vocabulary with human-readable messages, a parseInput utility, and the updated package entry point.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-types-detection-normalization/06-RESEARCH.md

@packages/x402lint/src/index.ts
@packages/x402lint/tsconfig.json
@packages/config/typescript/base.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Config types, validation types, and error vocabulary</name>
  <files>
    packages/x402lint/src/types/config.ts
    packages/x402lint/src/types/validation.ts
    packages/x402lint/src/types/errors.ts
  </files>
  <action>
Create three type definition files. Delete the `.gitkeep` in `src/types/` first.

**config.ts** -- TypeScript interfaces for all x402 config formats:

1. `ConfigFormat` type: `'v2' | 'v1' | 'flat-legacy' | 'unknown'`

2. `AcceptsEntry` interface for v2 accepts array entries:
   - `scheme: string` (required, e.g., "exact")
   - `network: string` (required, CAIP-2 format)
   - `amount: string` (required, atomic units integer string)
   - `asset: string` (required, asset address)
   - `payTo: string` (required, recipient address)
   - `maxTimeoutSeconds?: number | undefined` (optional)
   - `extra?: Record<string, unknown> | undefined` (optional, scheme-specific data like EIP-712 params)

3. `Resource` interface:
   - `url: string` (required)
   - `method?: string | undefined` (optional)
   - `headers?: Record<string, string> | undefined` (optional)
   - `body?: string | undefined` (optional)

4. `V2Config` interface:
   - `x402Version: 2` (literal type)
   - `accepts: AcceptsEntry[]`
   - `resource: Resource`
   - `error?: string | undefined`
   - `extensions?: Record<string, unknown> | undefined`

5. `V1Config` interface:
   - `x402Version: 1` (literal type)
   - `accepts: V1AcceptsEntry[]` (where V1AcceptsEntry has `maxAmountRequired` instead of `amount`, and per-entry `resource`)
   - `error?: string | undefined`
   - `extensions?: Record<string, unknown> | undefined`

6. `V1AcceptsEntry` interface (like AcceptsEntry but with v1 field names):
   - Same as AcceptsEntry but uses `maxAmountRequired: string` instead of `amount`
   - Has optional `resource?: Resource | undefined` (per-entry, not top-level)

7. `FlatLegacyConfig` interface -- root-level fields from v1.0 validator format:
   - `payTo?: string | undefined` or `address?: string | undefined`
   - `amount?: string | undefined` or `minAmount?: string | undefined`
   - `network?: string | undefined` or `chain?: string | undefined`
   - `currency?: string | undefined` or `asset?: string | undefined`
   - `maxTimeoutSeconds?: number | undefined`
   - `payments?: Array<Record<string, unknown>> | undefined` (array variant)
   - `extra?: Record<string, unknown> | undefined`
   - `extensions?: Record<string, unknown> | undefined`

8. `NormalizedConfig` interface -- canonical v2 shape that normalization produces:
   - `x402Version: 2` (literal)
   - `accepts: AcceptsEntry[]`
   - `resource?: Resource | undefined` (may be absent if source had none)
   - `error?: string | undefined`
   - `extensions?: Record<string, unknown> | undefined`

IMPORTANT: Use `exactOptionalPropertyTypes`-compatible patterns. Optional properties must use `prop?: T | undefined` syntax since the tsconfig has `exactOptionalPropertyTypes: true`.

**validation.ts** -- Result and issue types:

1. `Severity` type: `'error' | 'warning'`

2. `ValidationIssue` interface:
   - `code: ErrorCode` (from errors.ts)
   - `field: string` (dot-notation path, e.g., `accepts[0].network`)
   - `message: string` (human-readable)
   - `severity: Severity`
   - `fix?: string | undefined` (actionable suggestion, optional)

3. `ValidationResult` interface:
   - `valid: boolean`
   - `version: ConfigFormat`
   - `errors: ValidationIssue[]`
   - `warnings: ValidationIssue[]`
   - `normalized: NormalizedConfig | null`

4. `ParsedInput` interface:
   - `parsed: unknown`
   - `error?: ValidationIssue | undefined`

**errors.ts** -- Error code vocabulary using `as const` pattern:

1. `ErrorCode` const object with ALL error and warning codes:

   Structure errors:
   - `INVALID_JSON: 'INVALID_JSON'`
   - `NOT_OBJECT: 'NOT_OBJECT'`
   - `UNKNOWN_FORMAT: 'UNKNOWN_FORMAT'`

   Version errors:
   - `MISSING_VERSION: 'MISSING_VERSION'`
   - `INVALID_VERSION: 'INVALID_VERSION'`

   Accepts errors:
   - `MISSING_ACCEPTS: 'MISSING_ACCEPTS'`
   - `EMPTY_ACCEPTS: 'EMPTY_ACCEPTS'`
   - `INVALID_ACCEPTS: 'INVALID_ACCEPTS'`

   Field errors:
   - `MISSING_SCHEME: 'MISSING_SCHEME'`
   - `MISSING_NETWORK: 'MISSING_NETWORK'`
   - `INVALID_NETWORK_FORMAT: 'INVALID_NETWORK_FORMAT'`
   - `MISSING_AMOUNT: 'MISSING_AMOUNT'`
   - `INVALID_AMOUNT: 'INVALID_AMOUNT'`
   - `ZERO_AMOUNT: 'ZERO_AMOUNT'`
   - `MISSING_ASSET: 'MISSING_ASSET'`
   - `MISSING_PAY_TO: 'MISSING_PAY_TO'`
   - `MISSING_RESOURCE: 'MISSING_RESOURCE'`

   Address errors (codes only, validation is Phase 7):
   - `INVALID_EVM_ADDRESS: 'INVALID_EVM_ADDRESS'`
   - `BAD_EVM_CHECKSUM: 'BAD_EVM_CHECKSUM'`
   - `INVALID_SOLANA_ADDRESS: 'INVALID_SOLANA_ADDRESS'`
   - `ADDRESS_NETWORK_MISMATCH: 'ADDRESS_NETWORK_MISMATCH'`

   Warning codes:
   - `UNKNOWN_NETWORK: 'UNKNOWN_NETWORK'`
   - `UNKNOWN_ASSET: 'UNKNOWN_ASSET'`
   - `LEGACY_FORMAT: 'LEGACY_FORMAT'`
   - `MISSING_MAX_TIMEOUT: 'MISSING_MAX_TIMEOUT'`

2. `ErrorCode` type extracted: `type ErrorCode = typeof ErrorCode[keyof typeof ErrorCode]`

3. `ErrorMessages` const object: Record mapping each ErrorCode to a human-readable message template string. Example:
   - `INVALID_JSON: 'Input is not valid JSON'`
   - `MISSING_SCHEME: 'Missing required field: scheme'`
   - `INVALID_NETWORK_FORMAT: 'Network must use CAIP-2 format (namespace:reference), e.g. eip155:8453'`
   - `UNKNOWN_NETWORK: 'Network is not in the known registry -- config may still work but cannot be fully validated'`
   - `LEGACY_FORMAT: 'Config uses legacy flat format -- consider upgrading to x402 v2'`

   Every ErrorCode must have a corresponding entry in ErrorMessages. Use `satisfies Record<ErrorCode, string>` to enforce this at the type level.

All exports must be named exports (no default). Use `export const` and `export interface`/`export type`.
  </action>
  <verify>
Run `cd /Users/rawgroundbeef/Projects/x402lint && pnpm --filter x402lint run typecheck` -- must pass with zero errors.

Verify all error codes have messages: the `satisfies Record<ErrorCode, string>` constraint on ErrorMessages will cause a compile error if any code is missing a message.
  </verify>
  <done>
All config format interfaces (V2Config, V1Config, FlatLegacyConfig, NormalizedConfig) are defined. ErrorCode const object has 20+ codes. ErrorMessages maps every code to a human-readable string. ValidationResult and ValidationIssue types are defined. TypeScript compiles cleanly with strict mode.
  </done>
</task>

<task type="auto">
  <name>Task 2: Input parsing utility and package entry point</name>
  <files>
    packages/x402lint/src/types/parse-input.ts
    packages/x402lint/src/types/index.ts
    packages/x402lint/src/index.ts
  </files>
  <action>
**parse-input.ts** -- Utility for API-04 (string | object input handling):

Create `parseInput(input: string | object): ParsedInput` function:
- If `typeof input === 'string'`: try `JSON.parse(input)`, on success return `{ parsed }`, on catch return `{ parsed: null, error: { code: ErrorCode.INVALID_JSON, field: '$', message: ErrorMessages.INVALID_JSON, severity: 'error' } }`
- If `typeof input === 'object'`: return `{ parsed: input }`
- Import ErrorCode and ErrorMessages from `./errors`, ParsedInput and ValidationIssue from `./validation`

**types/index.ts** -- Barrel re-export:
- `export * from './config'`
- `export * from './validation'`
- `export * from './errors'`
- `export { parseInput } from './parse-input'`

**src/index.ts** -- Update the SDK entry point:
- Keep `export const VERSION = '0.0.1' as const`
- Uncomment and activate: `export * from './types'`
- Keep the detection/validation re-exports commented (for Phase 6 Plan 02 and Phase 8)

Then write a test file at `packages/x402lint/test/types.test.ts`:

```typescript
import { describe, it, expect } from 'vitest'
import {
  ErrorCode,
  ErrorMessages,
  parseInput,
  VERSION,
} from '../src/index'
import type {
  ConfigFormat,
  ValidationResult,
  ValidationIssue,
  V2Config,
  NormalizedConfig,
} from '../src/index'

describe('ErrorCode', () => {
  it('exports all error code constants', () => {
    expect(ErrorCode.INVALID_JSON).toBe('INVALID_JSON')
    expect(ErrorCode.MISSING_SCHEME).toBe('MISSING_SCHEME')
    expect(ErrorCode.INVALID_NETWORK_FORMAT).toBe('INVALID_NETWORK_FORMAT')
    expect(ErrorCode.UNKNOWN_NETWORK).toBe('UNKNOWN_NETWORK')
    expect(ErrorCode.LEGACY_FORMAT).toBe('LEGACY_FORMAT')
  })

  it('has a message for every error code', () => {
    const codes = Object.values(ErrorCode)
    for (const code of codes) {
      expect(ErrorMessages[code]).toBeDefined()
      expect(typeof ErrorMessages[code]).toBe('string')
      expect(ErrorMessages[code].length).toBeGreaterThan(0)
    }
  })
})

describe('parseInput', () => {
  it('parses valid JSON string', () => {
    const result = parseInput('{"x402Version": 2}')
    expect(result.parsed).toEqual({ x402Version: 2 })
    expect(result.error).toBeUndefined()
  })

  it('returns error for invalid JSON string', () => {
    const result = parseInput('not json')
    expect(result.parsed).toBeNull()
    expect(result.error).toBeDefined()
    expect(result.error!.code).toBe(ErrorCode.INVALID_JSON)
    expect(result.error!.field).toBe('$')
    expect(result.error!.severity).toBe('error')
  })

  it('passes through object input unchanged', () => {
    const obj = { x402Version: 2, accepts: [] }
    const result = parseInput(obj)
    expect(result.parsed).toBe(obj) // same reference
    expect(result.error).toBeUndefined()
  })

  it('handles empty JSON string', () => {
    const result = parseInput('')
    expect(result.error).toBeDefined()
    expect(result.error!.code).toBe(ErrorCode.INVALID_JSON)
  })
})
```
  </action>
  <verify>
Run `cd /Users/rawgroundbeef/Projects/x402lint && pnpm --filter x402lint run typecheck` -- must pass.
Run `cd /Users/rawgroundbeef/Projects/x402lint && pnpm --filter x402lint run test` -- all tests pass including new types.test.ts.
  </verify>
  <done>
parseInput handles both string and object inputs (API-04). types/index.ts re-exports all type modules. src/index.ts exports the type system. All tests pass. ErrorCode, ErrorMessages, parseInput, and all type interfaces are importable from the package entry point.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter x402lint run typecheck` passes with zero errors
2. `pnpm --filter x402lint run test` passes -- both existing smoke test and new types.test.ts
3. ErrorCode has 20+ codes covering structure, version, fields, addresses, and warnings
4. Every ErrorCode has a corresponding human-readable message in ErrorMessages
5. parseInput('valid json') returns parsed object, parseInput('garbage') returns INVALID_JSON error
6. All exports are named (no default exports)
</verification>

<success_criteria>
- ERR-01: Error codes exported as `as const` string constants
- ERR-02: ValidationIssue has `field` in dot-notation format
- ERR-03: ErrorMessages provides human-readable messages for every code
- ERR-04: ValidationIssue has optional `fix` field for suggestions
- ERR-05: Severity type distinguishes 'error' vs 'warning'
- API-04: parseInput accepts string | object
- API-07: All exports are named (no default)
</success_criteria>

<output>
After completion, create `.planning/phases/06-types-detection-normalization/06-01-SUMMARY.md`
</output>
