---
phase: 10-website-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/website/index.html
  - apps/website/input.js
autonomous: true

must_haves:
  truths:
    - "Website loads SDK via single IIFE script tag instead of ethers.js + bs58 + validator.js + chains.js"
    - "Pasting valid v2 config shows green Valid result with errors/warnings counts"
    - "Pasting legacy flat config shows warnings about deprecated format"
    - "URL validation flow still works (proxy fetch + config extraction + SDK validate)"
  artifacts:
    - path: "apps/website/index.html"
      provides: "Updated script tags (SDK IIFE replaces 4 old scripts), updated display logic for SDK result shape"
      contains: "x402lint@0.0.1/dist/index.iife.js"
    - path: "apps/website/input.js"
      provides: "Adapter layer mapping SDK validate() to old validateX402Config() shape"
      contains: "window.x402Lint.validate"
  key_links:
    - from: "apps/website/index.html"
      to: "SDK IIFE bundle"
      via: "script tag loading cdn.jsdelivr.net/npm/x402lint@0.0.1/dist/index.iife.js"
      pattern: "jsdelivr.*x402lint.*index\\.iife\\.js"
    - from: "apps/website/input.js"
      to: "window.x402Lint.validate"
      via: "adapter function validateX402Config calls SDK"
      pattern: "x402Lint\\.validate"
    - from: "apps/website/index.html renderDetails"
      to: "adapted normalized result"
      via: "display code reads normalized.payments from adapter output"
      pattern: "normalized\\.payments"
---

<objective>
Replace the website's 4 legacy script dependencies (ethers.js, bs58, validator.js, chains.js) with the SDK IIFE bundle and create an adapter layer so the existing display logic works unchanged.

Purpose: This is the core integration -- the website switches from hand-rolled validation to the spec-compliant SDK while preserving all existing UI behavior.
Output: Working website that validates via SDK with identical UX to current site.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-website-integration/10-RESEARCH.md
@apps/website/index.html
@apps/website/input.js
@apps/website/validator.js
@apps/website/chains.js
@packages/x402lint/src/types/validation.ts
@packages/x402lint/src/types/config.ts
@packages/x402lint/src/validation/orchestrator.ts
@packages/x402lint/dist/index.iife.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace script tags and create adapter layer in input.js</name>
  <files>apps/website/index.html, apps/website/input.js</files>
  <action>
**In `apps/website/index.html`:**

Replace the 5 script tags at the bottom (lines ~1142-1146):
```html
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js" ...></script>
<script src="https://cdn.jsdelivr.net/npm/bs58@6.0.0/dist/index.umd.js" ...></script>
<script src="chains.js"></script>
<script src="validator.js"></script>
<script src="input.js"></script>
```

With 2 script tags:
```html
<script src="https://cdn.jsdelivr.net/npm/x402lint@0.0.1/dist/index.iife.js" crossorigin="anonymous"></script>
<script src="input.js"></script>
```

Note: Omit SRI integrity hash for now -- the package is not yet published to npm. SRI will be added when publishing. Do NOT include `integrity` attribute without a real hash (it would break loading).

**In `apps/website/input.js`:**

Add the adapter function `validateX402Config()` at the top of the file (after the constants). This function must be globally available because the inline `<script>` in index.html calls it directly.

The adapter must:
1. Call `window.x402Lint.validate(configText)` to get the SDK result
2. Map the SDK result shape to the old result shape that the display logic expects

Key mappings:
- `sdkResult.version` -> `result.detectedFormat` (with value mapping: `'flat-legacy'` -> `'flat'`, others pass through)
- `sdkResult.errors[].{code,field,message,severity,fix}` -> `result.errors[].{field,message,fix}` (strip code and severity)
- `sdkResult.warnings[]` -> same stripping
- `sdkResult.normalized` (NormalizedConfig with `accepts[]` array) -> `result.normalized` with `payments[]` array

The normalized adapter must convert:
- `normalized.accepts[].network` (CAIP-2 like "eip155:8453") -> `payments[].chain` (simple name like "base")
- `normalized.accepts[].payTo` -> `payments[].address`
- `normalized.accepts[].amount` -> `payments[].minAmount`
- `normalized.accepts[].asset` -> `payments[].asset`
- Add `_normalizedAmount` object for display (the old `normalizeAmount()` function behavior)

Include a reverse CAIP-2 lookup map for display:
```javascript
const CAIP2_TO_SIMPLE = {
  'eip155:8453': 'base',
  'eip155:84532': 'base-sepolia',
  'eip155:43114': 'avalanche',
  'eip155:43113': 'avalanche-fuji',
  'solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp': 'solana',
  'solana:EtWTRABZaYq6iMfeYKouRu166VU2xqa1': 'solana-devnet',
  'solana:4uhcVJyU9pJkvQyS88uRDiswHXSCkY3z': 'solana-testnet',
};
```

Keep the `normalizeAmount()` function for display purposes (amount formatting). It already exists in validator.js -- move it to input.js since validator.js will be removed.

Also keep the `generateV2Equivalent()` function -- move it to input.js or inline in index.html. Update it to use the SDK's normalize function: `window.x402Lint.normalize(config)` returns a NormalizedConfig with `accepts[]` array. Map back to the old "v2" shape for display.

The `handleValidation()` function in input.js already works correctly -- it calls `validateX402Config()` which the adapter provides. The `testX402Url()` function also calls `validateX402Config()` on line 120. Both will automatically use the adapter.

Important: Do NOT change the display logic in index.html (renderVerdict, renderDetails functions). The adapter's job is to make the SDK output look exactly like the old validator output so the display code works without changes.

Handling `v2-marketplace` format: The SDK does NOT have a `v2-marketplace` format. The old validator detected marketplace by checking for `metadata`/`outputSchema`/`inputSchema` fields. The display code checks `validation.detectedFormat.startsWith('v2')`. Since SDK returns 'v2' for all v2 configs, this works correctly. However, the `formatLabels` map in index.html has a 'v2-marketplace' key. The adapter should check if `sdkResult.normalized?.extensions?.metadata` or `sdkResult.normalized?.extensions?.outputSchema` exists and map to 'v2-marketplace' when present. This preserves the marketplace badge in the UI.

Wait -- actually looking at the SDK output more carefully: the SDK's normalized output is a `NormalizedConfig` with `x402Version: 2, accepts: [], resource?, error?, extensions?`. The old validator put `metadata` and `outputSchema` at root level of normalized. The SDK puts them in `extensions` if they were in the original config. The adapter should check `sdkResult.normalized?.extensions` for these fields.

Also: the old display code accesses `validation.normalized.metadata` (line 1399) to show marketplace readiness. The adapter should map `sdkResult.normalized.extensions?.metadata` to `adapted.metadata`.
  </action>
  <verify>
1. Open `apps/website/index.html` in a browser
2. Check browser console for no script loading errors
3. Check `window.x402Lint` exists and has `.validate` function
4. Paste a flat config like `{"amount": 0.025, "currency": "USDC", "network": "solana", "payTo": "5F5Yy9qJov8xK67vEWRoZHppWHEmH3WuG7mSfvLuqUTz"}` and click Validate
5. Verify result shows: format badge, error/warning counts, parsed config section with Chain/Address/Amount/Asset rows
6. Paste invalid JSON like `{broken` and verify error display works
  </verify>
  <done>
- index.html has 2 script tags (SDK IIFE + input.js) instead of 5
- validateX402Config() adapter in input.js calls window.x402Lint.validate() and maps result
- Display logic renders validation results correctly for flat, v1, and v2 configs
- No console errors from missing scripts or undefined references
  </done>
</task>

<task type="auto">
  <name>Task 2: Update display logic for SDK-specific result differences</name>
  <files>apps/website/index.html</files>
  <action>
Review and update the inline `<script>` display logic in index.html for any remaining incompatibilities with the adapted SDK output. The adapter handles most differences, but some display code may reference fields or values that changed.

Specific updates needed:

1. **Format labels map** (around line 1322): The current map is:
```javascript
const formatLabels = {
  'flat': 'Flat (Simple)',
  'v1': 'accepts (v1)',
  'v2': 'payments (v2)',
  'v2-marketplace': 'v2 + Marketplace'
};
```
Update to also handle SDK format names. Since the adapter maps `flat-legacy` -> `flat`, and the SDK returns `v2` (not `v2-marketplace`), and the adapter handles marketplace detection, these labels should work. However, update the labels to be spec-correct:
```javascript
const formatLabels = {
  'flat': 'Flat (Legacy)',
  'v1': 'v1 (accepts)',
  'v2': 'v2 (Canonical)',
  'v2-marketplace': 'v2 + Marketplace'
};
```

2. **Tab labels** (around line 981): Update example tab labels to match new format names. The current tabs are "Flat (Simple)", "accepts (v1)", "payments (v2)", "+ Marketplace". These labels are in the HTML, not JS, so they are user-facing descriptions -- they can stay as-is for UX clarity. But do rename:
- "Flat (Simple)" -> "Flat (Legacy)" to signal it's deprecated
- "payments (v2)" -> "v2 (Canonical)" to signal it's the recommended format

3. **generateV2Equivalent function** (around line 1467): This function is called by the "Show v2 equivalent" button. It currently calls `normalizeConfig(config)` from validator.js which will no longer exist. Move this logic to use the SDK. Replace with:
```javascript
function showV2Equivalent() {
  try {
    const config = JSON.parse(inputEl.value);
    const normalized = window.x402Lint.normalize(config);
    if (normalized) {
      inputEl.value = JSON.stringify(normalized, null, 2);
      validateBtn.click();
    }
  } catch (e) {
    // ignore
  }
}
```
This uses the SDK's `normalize()` which returns a canonical v2 NormalizedConfig. Note: this replaces the old `generateV2Equivalent()` function entirely.

4. **Verdict format section**: The `formatClass` calculation on line 1328 does `validation.detectedFormat.startsWith('v2')`. This still works with the adapter output. No change needed.

5. **Upgrade button**: The "Show v2 equivalent" button (line 1331) shows when format is not v2. This still works correctly.

6. **FAQ "Which chains and formats"** (around line 1103): Update the answer to mention CAIP-2 format and the SDK:
- Update chain list from `solana, base, solana-devnet, base-sepolia` to mention they use CAIP-2 identifiers
- Update format list to mention "flat-legacy" instead of "flat"
- Mention this is powered by the x402lint SDK

Important: Do NOT rewrite the renderVerdict or renderDetails functions. They should work with the adapter output. Only fix specific field references or values that don't match.
  </action>
  <verify>
1. Open index.html in browser
2. Validate flat config -> verify "Flat (Legacy)" format badge appears
3. Click "Show v2 equivalent" button -> verify it converts to canonical v2 NormalizedConfig JSON and re-validates
4. Validate v2 config -> verify "v2 (Canonical)" format badge appears
5. Check FAQ section renders correctly with updated chain/format info
6. No console errors
  </verify>
  <done>
- Format labels updated to spec-correct names
- Tab labels updated (Flat Legacy, v2 Canonical)
- showV2Equivalent uses SDK normalize() instead of removed generateV2Equivalent
- FAQ updated with CAIP-2 and SDK mentions
- All display paths render correctly with adapted SDK output
  </done>
</task>

</tasks>

<verification>
1. Open apps/website/index.html in browser
2. Verify only 2 script tags load (check Network tab or view source)
3. In console: `typeof window.x402Lint.validate === 'function'` returns true
4. Paste flat config -> shows "Flat (Legacy)" badge, warnings about deprecated format, parsed config details
5. Paste v2 config -> shows "v2 (Canonical)" badge, valid result with green checkmark
6. Paste invalid JSON -> shows error message
7. Use "Show v2 equivalent" on flat config -> converts to canonical v2 and re-validates
8. No console errors throughout all flows
</verification>

<success_criteria>
- Website loads with 2 script tags instead of 5
- SDK validate() is called via adapter for all validation flows (JSON paste + URL fetch)
- Display renders errors, warnings, format badge, and parsed config correctly
- Show v2 equivalent works using SDK normalize()
- No console errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-website-integration/10-01-SUMMARY.md`
</output>
