---
phase: 09-build-pipeline-and-package-publishing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/x402check/tsdown.config.ts
  - packages/x402check/package.json
autonomous: true

must_haves:
  truths:
    - "ESM import works: import { validate } from 'x402check' resolves and validate is a function"
    - "CJS require works: const { validate } = require('x402check') resolves and validate is a function"
    - "UMD bundle exposes window.x402Validate with validate, detect, normalize as callable functions"
    - "Browser bundle (UMD) is under 15KB minified"
    - "TypeScript consumers get full type inference on validate() return type"
  artifacts:
    - path: "packages/x402check/dist/index.mjs"
      provides: "ESM bundle"
    - path: "packages/x402check/dist/index.cjs"
      provides: "CJS bundle"
    - path: "packages/x402check/dist/index.d.ts"
      provides: "TypeScript declarations"
    - path: "packages/x402check/dist/index.d.mts"
      provides: "ESM-specific TypeScript declarations"
    - path: "packages/x402check/dist/index.d.cts"
      provides: "CJS-specific TypeScript declarations"
    - path: "packages/x402check/dist/index.umd.js"
      provides: "UMD browser bundle (minified)"
    - path: "packages/x402check/tsdown.config.ts"
      provides: "Multi-format build configuration"
    - path: "packages/x402check/package.json"
      provides: "Package metadata with correct exports, files, sideEffects"
  key_links:
    - from: "packages/x402check/package.json exports.'.'.import"
      to: "packages/x402check/dist/index.mjs"
      via: "Node.js module resolution"
      pattern: '"import":\\s*"\\./dist/index\\.mjs"'
    - from: "packages/x402check/package.json exports.'.'.require"
      to: "packages/x402check/dist/index.cjs"
      via: "Node.js module resolution"
      pattern: '"require":\\s*"\\./dist/index\\.cjs"'
    - from: "packages/x402check/package.json exports.'.'.types"
      to: "packages/x402check/dist/index.d.ts"
      via: "TypeScript module resolution"
      pattern: '"types":\\s*"\\./dist/index\\.d\\.ts"'
    - from: "packages/x402check/tsdown.config.ts UMD globalName"
      to: "window.x402Validate"
      via: "UMD bundle global assignment"
      pattern: "globalName:\\s*'x402Validate'"
---

<objective>
Configure tsdown for multi-format builds (ESM + CJS + UMD), update package.json with correct exports/files/sideEffects fields, build the SDK, and verify all output artifacts meet requirements (correct files, bundle size under 15KB, types resolve, ESM/CJS/UMD all work).

Purpose: This is the build pipeline that turns the TypeScript SDK source into distributable packages. Without this, the SDK cannot be consumed by Node.js projects (ESM/CJS), browser apps (UMD), or TypeScript projects (declarations).

Output: Working multi-format build in dist/, verified package.json exports, and publish-ready package configuration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-build-pipeline-and-package-publishing/09-RESEARCH.md

@packages/x402check/tsdown.config.ts
@packages/x402check/package.json
@packages/x402check/tsconfig.json
@packages/x402check/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure tsdown multi-format build and update package.json</name>
  <files>
    packages/x402check/tsdown.config.ts
    packages/x402check/package.json
  </files>
  <action>
    **tsdown.config.ts** - Replace the current single-format config with a multi-format array config:

    Config entry 1 (ESM + CJS for Node.js and bundlers):
    - entry: './src/index.ts'
    - format: ['esm', 'cjs']
    - platform: 'neutral'
    - dts: true (generates .d.ts, .d.mts, .d.cts)
    - sourcemap: true
    - minify: false (don't minify Node builds)
    - clean: true (clean dist/ before first build)
    - outDir: 'dist'
    - external: [] (no runtime deps to externalize)

    Config entry 2 (UMD for browser script tag):
    - entry: './src/index.ts'
    - format: ['umd']
    - platform: 'browser'
    - globalName: 'x402Validate' (window.x402Validate)
    - target: ['es2020'] (broad browser support)
    - minify: true (minimize browser bundle size)
    - sourcemap: false (no sourcemaps in UMD)
    - dts: false (no types for UMD)
    - clean: false (don't clean, ESM/CJS build already wrote to dist/)
    - outDir: 'dist'
    - external: [] (bundle everything, zero runtime deps)

    **package.json** - Update to match build outputs and add publish-readiness:

    1. Fix "module" field: change "./dist/index.js" to "./dist/index.mjs" (tsdown ESM output uses .mjs extension)
    2. Fix exports.".".import: change "./dist/index.js" to "./dist/index.mjs"
    3. Ensure exports.".".types comes FIRST (already does, keep it)
    4. Add "files": ["dist/"] to whitelist only dist/ for npm publish
    5. Add "sideEffects": false for tree-shaking by downstream bundlers
    6. Add scripts:
       - "prepublishOnly": "pnpm test && pnpm build && publint"
       - Keep existing build, test, test:watch, lint, typecheck scripts
    7. Add devDependencies:
       - "publint": "^0.3.16"
    8. Keep all existing devDependencies unchanged
    9. Add "repository", "homepage", "bugs" fields:
       - "repository": { "type": "git", "url": "https://github.com/anthropics/x402check" }
       (Use a placeholder URL - user can update before actual publish)

    Do NOT add @arethetypeswrong/cli yet -- publint is sufficient for pre-publish validation and attw can be added later if needed. Keep the dependency footprint minimal.

    Do NOT change the "name", "version", "description", "type", "license", or "keywords" fields.
  </action>
  <verify>
    Run `cat packages/x402check/tsdown.config.ts` to confirm multi-format array config with ESM/CJS and UMD entries.
    Run `cat packages/x402check/package.json` to confirm:
    - "module" points to "./dist/index.mjs"
    - exports.".".import points to "./dist/index.mjs"
    - exports.".".require points to "./dist/index.cjs"
    - exports.".".types comes FIRST
    - "files" field exists with ["dist/"]
    - "sideEffects": false is present
    - prepublishOnly script exists
    - publint is in devDependencies
  </verify>
  <done>
    tsdown.config.ts has two build configurations (ESM+CJS and UMD).
    package.json has correct exports paths (.mjs), files whitelist, sideEffects, and publish validation script.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build SDK and verify all output artifacts</name>
  <files>
    packages/x402check/dist/ (build output, not committed)
  </files>
  <action>
    1. Install dependencies: Run `pnpm install` from repo root to install publint.

    2. Run the build: Execute `pnpm --filter x402check build` from repo root.
       If the build fails, diagnose and fix the tsdown config. Common issues:
       - @noble/hashes import paths need .js extension (already done in Phase 7)
       - UMD format might need `format: 'iife'` instead of `'umd'` depending on tsdown version -- if UMD is not supported, try IIFE format which is functionally equivalent for browser script tags
       - If tsdown doesn't support array config, use two separate defineConfig calls or a single config with format: ['esm', 'cjs'] and a separate build step for UMD

    3. Verify output files exist:
       - dist/index.mjs (ESM bundle)
       - dist/index.cjs (CJS bundle)
       - dist/index.d.ts (TypeScript declarations)
       - dist/index.d.mts (ESM TypeScript declarations) -- this may or may not be generated depending on tsdown version, acceptable if only .d.ts is generated
       - dist/index.d.cts (CJS TypeScript declarations) -- same as above
       - dist/index.umd.js OR dist/index.global.js (UMD/IIFE browser bundle) -- filename varies by tsdown version and format choice

    4. Measure browser bundle size:
       Run `ls -lh dist/index.umd.js` (or whatever the UMD/IIFE output file is named).
       It MUST be under 15KB (15360 bytes). If over 15KB:
       - Check if sourcemaps are accidentally embedded
       - Verify external: [] is set (no external deps to inline, but also no unnecessary deps)
       - Check that tree-shaking is working (sideEffects: false)
       - As a last resort, check for debug-only code paths

    5. Verify ESM import works:
       Create a temp test file and run it with Node.js:
       ```
       echo 'import { validate, detect, normalize, VERSION } from "./packages/x402check/dist/index.mjs"; console.log("ESM OK:", typeof validate, typeof detect, typeof normalize, VERSION);' > /tmp/test-esm.mjs
       node /tmp/test-esm.mjs
       ```
       Expected output: "ESM OK: function function function 0.0.1"

    6. Verify CJS require works:
       ```
       echo 'const { validate, detect, normalize, VERSION } = require("./packages/x402check/dist/index.cjs"); console.log("CJS OK:", typeof validate, typeof detect, typeof normalize, VERSION);' > /tmp/test-cjs.cjs
       node /tmp/test-cjs.cjs
       ```
       Expected output: "CJS OK: function function function 0.0.1"

    7. Verify UMD bundle works in a pseudo-browser context:
       ```
       echo 'globalThis.window = globalThis; require("./packages/x402check/dist/index.umd.js"); console.log("UMD OK:", typeof window.x402Validate.validate, typeof window.x402Validate.detect, typeof window.x402Validate.normalize);' > /tmp/test-umd.cjs
       node /tmp/test-umd.cjs
       ```
       Expected output: "UMD OK: function function function"
       Note: Adjust the filename if tsdown outputs as .global.js or different name.

    8. Run existing tests to confirm build config changes didn't break anything:
       `pnpm --filter x402check test`

    9. Run publint to validate package configuration:
       `cd packages/x402check && npx publint`
       Fix any issues reported by publint.

    10. If the UMD output filename is not `index.umd.js`, note the actual filename for Phase 10 (website integration). The website will need to reference this exact filename.
  </action>
  <verify>
    All verification commands from the action steps above must pass:
    - `pnpm --filter x402check build` exits 0
    - dist/ contains ESM (.mjs), CJS (.cjs), declarations (.d.ts), and UMD/IIFE bundle
    - UMD/IIFE bundle is under 15KB
    - ESM test prints "ESM OK: function function function 0.0.1"
    - CJS test prints "CJS OK: function function function 0.0.1"
    - UMD test prints "UMD OK: function function function"
    - `pnpm --filter x402check test` passes all existing tests
    - `npx publint` reports no errors (warnings acceptable)
  </verify>
  <done>
    Build produces ESM, CJS, and UMD/IIFE bundles.
    All three formats export validate, detect, normalize as callable functions.
    UMD bundle is under 15KB minified.
    TypeScript declarations are generated.
    All existing tests still pass.
    publint validates the package configuration.
  </done>
</task>

</tasks>

<verification>
Phase 9 success criteria mapped to verification:

1. "import { validate } from 'x402check' works in ESM" -- Verified by Task 2 step 5 (ESM import test)
2. "const { validate } = require('x402check') works in CJS" -- Verified by Task 2 step 6 (CJS require test)
3. "Loading UMD bundle makes window.x402Validate.validate callable" -- Verified by Task 2 step 7 (UMD test)
4. "Browser bundle under 15KB minified" -- Verified by Task 2 step 4 (ls -lh size check)
5. "TypeScript consumers get full type inference" -- Verified by .d.ts/.d.mts/.d.cts generation in build output + publint validation

Additional verification:
- All 217+ existing tests pass after build config changes
- publint validates package.json exports/types/files configuration
</verification>

<success_criteria>
- dist/index.mjs, dist/index.cjs, dist/index.d.ts all exist and are non-empty
- UMD/IIFE browser bundle exists and is under 15,360 bytes
- ESM import resolves validate, detect, normalize as functions
- CJS require resolves validate, detect, normalize as functions
- UMD bundle assigns validate, detect, normalize to window.x402Validate
- All existing SDK tests pass
- publint reports no errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-build-pipeline-and-package-publishing/09-01-SUMMARY.md`
</output>
