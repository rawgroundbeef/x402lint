---
phase: 02-input-proxy
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified: [index.html, input.js]
autonomous: false

must_haves:
  truths:
    - "User can paste URL and submit for validation"
    - "User can paste JSON and submit for validation"
    - "Input auto-detects URL vs JSON (no tabs/toggles)"
    - "Loading state shows during URL fetch"
    - "Config extracted from PAYMENT-REQUIRED header or response body"
    - "Config source displayed in results (header vs body)"
    - "Errors display in results area"
  artifacts:
    - path: "input.js"
      provides: "Input detection, URL fetching, config extraction"
      min_lines: 100
      exports: ["detectInputType", "fetchConfigFromUrl", "extractX402Config"]
    - path: "index.html"
      provides: "Updated UI with smart input and loading states"
      contains: "input.js"
  key_links:
    - from: "index.html"
      to: "input.js"
      via: "script tag"
      pattern: "src=\"input.js\""
    - from: "input.js"
      to: "validator.js"
      via: "validateX402Config call"
      pattern: "validateX402Config"
    - from: "input.js"
      to: "worker proxy"
      via: "fetch call"
      pattern: "workers.dev"
---

<objective>
Add smart input handling with URL fetching via CORS proxy, enabling users to paste either URLs or JSON configs for validation.

Purpose: This completes the input layer, allowing developers to validate configs by either pasting JSON directly or entering the URL of their x402 endpoint. The proxy (from 02-01) enables fetching from any URL.

Output: Enhanced index.html with smart input detection, input.js with URL fetching and config extraction logic.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-input-proxy/02-RESEARCH.md
@.planning/phases/02-input-proxy/02-CONTEXT.md
@.planning/phases/02-input-proxy/02-01-SUMMARY.md (for proxy URL)
@index.html
@validator.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create input.js with fetch and extraction logic</name>
  <files>input.js</files>
  <action>
    Create input.js with the following functions:

    **detectInputType(input):**
    - Trim input
    - Return 'url' if starts with 'http://' or 'https://'
    - Return 'json' otherwise

    **fetchConfigFromUrl(url, proxyBaseUrl):**
    - Validate URL format using URL constructor (throw Error if invalid)
    - Build proxy URL: `${proxyBaseUrl}?url=${encodeURIComponent(url)}`
    - Fetch with AbortSignal.timeout(5000) for 5 second timeout
    - Handle TimeoutError: throw "Request timeout after 5 seconds - Check URL is reachable"
    - Handle AbortError: throw "Request was cancelled"
    - Handle network errors: throw "Network error: {message}"
    - Check response.ok or status 402: if other status, throw "HTTP {status}: {statusText}"
    - Call extractX402Config(response) and return result
    - Return object: { config, source, status, warning? }

    **extractX402Config(response):**
    - Priority 1: Check PAYMENT-REQUIRED header
      - If present, try to decode as base64 (atob), then JSON.parse
      - If decode fails, try direct JSON.parse (fallback)
      - Return { config: JSON string, source: 'PAYMENT-REQUIRED header', status }
    - Priority 2: Check response body
      - Check Content-Type includes 'application/json'
      - Read response.text() and JSON.parse to validate
      - Return { config: body text, source: 'response body', status }
      - If status !== 402, add warning: "Response status: {status} - x402 endpoints should return 402 Payment Required"
    - If neither: throw "No x402 Config Found - Response had no PAYMENT-REQUIRED header or valid JSON body"

    **formatJsonForDisplay(jsonString):**
    - Try JSON.parse then JSON.stringify with 2-space indent
    - Return formatted string or original if invalid

    **Constants:**
    - PROXY_URL: Get from 02-01-SUMMARY.md (deployed worker URL)
    - FETCH_TIMEOUT_MS: 5000

    Reference Patterns 2, 4 from 02-RESEARCH.md.
    Handle Pitfalls 1, 5, 6, 7 from 02-RESEARCH.md.
  </action>
  <verify>
    File exists: `ls input.js`
    Functions exported: `grep -E "function (detectInputType|fetchConfigFromUrl|extractX402Config)" input.js`
    Uses AbortSignal.timeout: `grep "AbortSignal.timeout" input.js`
    Checks PAYMENT-REQUIRED: `grep "PAYMENT-REQUIRED" input.js`
  </verify>
  <done>
    input.js contains:
    - detectInputType() distinguishing URL from JSON
    - fetchConfigFromUrl() with timeout and error handling
    - extractX402Config() with header/body priority
    - formatJsonForDisplay() for pretty-printing
    - Proxy URL configured
  </done>
</task>

<task type="auto">
  <name>Task 2: Update index.html with smart input UI</name>
  <files>index.html</files>
  <action>
    Update index.html to implement smart input from CONTEXT.md decisions:

    **Input field changes:**
    - Keep existing textarea but update placeholder: "Paste a URL or x402 JSON config..."
    - Add CSS for single-line start that expands (min-height: 50px, max-height: 300px)
    - Add .url-mode and .json-mode CSS classes for visual feedback
    - Add .loading class for button disabled state

    **Button changes:**
    - Update #validate-btn text to show "Validating..." during fetch
    - Add CSS for disabled/loading state (cursor: not-allowed, opacity)
    - Prevent double-submit by disabling during validation

    **Results display enhancements:**
    - Add source display: "found in X-Payment header" or "found in response body"
    - Add CSS for source info styling
    - Ensure fetch errors display in same results area
    - Show HTTP status when relevant

    **Script section updates:**
    - Add script tag for input.js (after validator.js)
    - Update click handler to:
      1. Disable button immediately, show "Validating..."
      2. Detect input type
      3. If URL: fetch config via proxy, then validate
      4. If JSON: validate directly
      5. Display results with source info for URL mode
      6. Always re-enable button in finally block
    - Add paste event listener to auto-format JSON
    - Add input event listener to clear invalid-json class

    **CSS additions:**
    - .loading class for button
    - .url-mode / .json-mode for input field
    - .source-info styling for config source display
    - .status-warning for non-402 warning

    Reference Patterns 5, 6 from 02-RESEARCH.md for loading state and auto-expand.
  </action>
  <verify>
    Script included: `grep 'src="input.js"' index.html`
    Loading class: `grep "loading" index.html`
    Source display: `grep "source" index.html`
  </verify>
  <done>
    index.html updated with:
    - Smart input textarea with expand behavior
    - Loading state for validate button
    - Source info display in results
    - Auto-format on JSON paste
    - Proper error handling and display
    - input.js script included
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify input and fetch functionality</name>
  <what-built>
    Smart input detection with URL fetching via CORS proxy:
    - Single textarea that auto-detects URL vs JSON
    - URL fetch with 5 second timeout
    - Config extraction from PAYMENT-REQUIRED header or response body
    - Loading states and error display
  </what-built>
  <how-to-verify>
    1. Open index.html in browser (python3 -m http.server 8000)
    2. Test JSON input:
       - Paste valid JSON config
       - Click Validate
       - Should show validation results immediately
    3. Test URL input:
       - Enter URL of known x402 endpoint (or use a test URL)
       - Click Validate
       - Should show "Validating..." then results
       - Check source info shows "header" or "body"
    4. Test error handling:
       - Enter invalid URL (e.g., "not-a-url")
       - Should show "Invalid URL format" error
       - Enter unreachable URL
       - Should show timeout or network error after 5s
    5. Test loading state:
       - Button should be disabled during fetch
       - Button should re-enable after completion (success or error)
  </how-to-verify>
  <resume-signal>Type "approved" if working, or describe specific issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] input.js exists with all required functions
- [ ] index.html includes input.js script
- [ ] URL detection works (http:// and https://)
- [ ] JSON input validates immediately
- [ ] URL fetch shows loading state
- [ ] Config source displayed in results
- [ ] Errors display in results area
- [ ] Button disabled during fetch, re-enabled after
</verification>

<success_criteria>
User can paste either a URL or JSON config. URL inputs are fetched via proxy with proper timeout and error handling. Config source (header vs body) is displayed. Loading states prevent double-submit.
</success_criteria>

<output>
After completion, create `.planning/phases/02-input-proxy/02-02-SUMMARY.md`
</output>
