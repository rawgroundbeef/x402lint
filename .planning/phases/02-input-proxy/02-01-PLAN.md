---
phase: 02-input-proxy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [worker/proxy.js, wrangler.toml]
autonomous: false

user_setup:
  - service: cloudflare-workers
    why: "CORS proxy for fetching x402 configs from arbitrary URLs"
    env_vars: []
    dashboard_config:
      - task: "Create Cloudflare account (if needed)"
        location: "https://dash.cloudflare.com/sign-up"
      - task: "Run wrangler login to authenticate CLI"
        location: "Terminal"

must_haves:
  truths:
    - "Worker code exists and handles CORS preflight requests"
    - "Worker forwards requests to target URLs and adds CORS headers"
    - "Worker validates Origin header for security"
    - "Worker returns appropriate errors for missing/invalid URL parameter"
  artifacts:
    - path: "worker/proxy.js"
      provides: "Cloudflare Worker fetch handler with CORS support"
      min_lines: 50
    - path: "wrangler.toml"
      provides: "Worker configuration for deployment"
      contains: "name ="
  key_links:
    - from: "worker/proxy.js"
      to: "external URLs"
      via: "fetch() call with target URL"
      pattern: "fetch\\(targetUrl"
---

<objective>
Create Cloudflare Worker CORS proxy that enables fetching x402 configs from arbitrary URLs.

Purpose: Browser CORS policies prevent direct fetching from arbitrary URLs. This proxy adds proper CORS headers and forwards requests, enabling the validation tool to fetch configs from any x402 endpoint.

Output: Worker code ready for deployment, wrangler configuration file.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-input-proxy/02-RESEARCH.md
@.planning/phases/02-input-proxy/02-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Cloudflare Worker proxy with CORS handling</name>
  <files>worker/proxy.js, wrangler.toml</files>
  <action>
    Create `worker/` directory and Cloudflare Worker files:

    **worker/proxy.js:**
    - Export default object with async fetch(request) handler (Cloudflare Workers ES modules format)
    - Handle OPTIONS preflight requests:
      - Return 204 with CORS headers: Access-Control-Allow-Origin (from request Origin), Access-Control-Allow-Methods (GET, HEAD, POST, OPTIONS), Access-Control-Allow-Headers (Content-Type), Access-Control-Max-Age (86400)
    - Extract target URL from `?url=` query parameter using `new URL(request.url).searchParams.get('url')`
    - Return 400 with "Missing ?url= parameter" if no url param
    - Validate target URL format using `new URL(targetUrl)` constructor in try-catch
    - Return 400 with "Invalid target URL" if URL constructor throws
    - Validate Origin header against allowed origins array:
      - Allow: 'http://localhost:8000', 'http://localhost:3000', 'http://127.0.0.1:8000'
      - Also allow null Origin (direct browser navigation) for testing
      - Return 403 with "Forbidden" if Origin not in allowlist
    - Block internal IP ranges (security - prevent SSRF):
      - Check if targetUrl hostname matches: 169.254.x.x, 10.x.x.x, 192.168.x.x, 127.x.x.x, localhost
      - Return 403 with "Internal URLs not allowed" if blocked
    - Forward GET request to target URL:
      - Use fetch(targetUrl, { headers: { 'User-Agent': 'x402lint/1.0' } })
      - Wrap in try-catch for network errors
      - Return 502 with "Proxy error: {message}" on fetch failure
    - Build response with CORS headers:
      - Create new Response(response.body, { status, statusText, headers: response.headers })
      - Set Access-Control-Allow-Origin to request Origin (or '*' if null)
      - Set Access-Control-Expose-Headers to 'PAYMENT-REQUIRED, X-Payment' (exposes x402 headers to client)
      - Return the new response

    **wrangler.toml:**
    - name = "x402-proxy"
    - main = "proxy.js"
    - compatibility_date = "2024-01-01"
    - Add comment: # Deploy with: npx wrangler deploy

    Reference Pattern 3 (Cloudflare Worker CORS Proxy) from 02-RESEARCH.md.
    Handle Pitfall 2 (Open CORS Proxy Abuse) by validating Origin header.
  </action>
  <verify>
    Files exist: `ls worker/proxy.js wrangler.toml`
    Worker exports fetch handler: `grep "export default" worker/proxy.js`
    Handles OPTIONS: `grep "OPTIONS" worker/proxy.js`
    Validates Origin: `grep -E "(Origin|allowedOrigins)" worker/proxy.js`
    Exposes x402 headers: `grep "PAYMENT-REQUIRED" worker/proxy.js`
    Blocks internal IPs: `grep -E "(169\\.254|10\\.|192\\.168|localhost)" worker/proxy.js`
  </verify>
  <done>
    worker/proxy.js contains complete Cloudflare Worker with:
    - CORS preflight handling (OPTIONS returns 204 with headers)
    - URL parameter extraction and validation (400 on missing/invalid)
    - Origin header validation against allowlist (403 on forbidden)
    - Internal IP blocking (403 on SSRF attempt)
    - Request forwarding with User-Agent header
    - Response with CORS headers exposing PAYMENT-REQUIRED
    - Error responses for proxy failures (502)
    wrangler.toml configured with name, main, and compatibility_date
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Deploy Worker and record URL</name>
  <action>
    User deploys the Cloudflare Worker and provides the deployed URL.
  </action>
  <instructions>
    1. Open terminal in project root
    2. If first time: `npx wrangler login` (opens browser for Cloudflare auth)
    3. Deploy: `cd worker && npx wrangler deploy`
    4. Copy the deployed URL (looks like: https://x402-proxy.{account}.workers.dev)
    5. Respond with the URL

    Expected output:
    ```
    Deployed x402-proxy
    https://x402-proxy.youraccount.workers.dev
    ```

    The URL will be needed for Plan 02-02 to configure fetch requests.
  </instructions>
  <verify>User provides deployed worker URL matching pattern https://*.workers.dev</verify>
  <done>Worker deployed to Cloudflare, URL recorded for use in input.js (Plan 02-02)</done>
  <resume-signal>Paste the deployed worker URL (e.g., https://x402-proxy.xxx.workers.dev)</resume-signal>
</task>

</tasks>

<verification>
- [ ] worker/proxy.js exists with fetch handler
- [ ] wrangler.toml exists with correct configuration
- [ ] Worker validates Origin header (security)
- [ ] Worker blocks internal IP addresses (SSRF protection)
- [ ] Worker exposes PAYMENT-REQUIRED header in CORS
- [ ] Worker deployed to Cloudflare
- [ ] Deployed URL obtained for Plan 02-02
</verification>

<success_criteria>
Cloudflare Worker deployed and accessible, ready to proxy requests for URL validation in Plan 02-02.
</success_criteria>

<output>
After completion, create `.planning/phases/02-input-proxy/02-01-SUMMARY.md`

Record the deployed worker URL in the summary for Plan 02-02 to reference.
</output>
