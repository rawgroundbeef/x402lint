---
phase: 02-input-proxy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [worker/proxy.js, wrangler.toml]
autonomous: false

user_setup:
  - service: cloudflare-workers
    why: "CORS proxy for fetching x402 configs from arbitrary URLs"
    env_vars: []
    dashboard_config:
      - task: "Create Cloudflare account (if needed)"
        location: "https://dash.cloudflare.com/sign-up"
      - task: "Run wrangler login to authenticate CLI"
        location: "Terminal"

must_haves:
  truths:
    - "Worker code exists and handles CORS preflight requests"
    - "Worker forwards requests to target URLs and adds CORS headers"
    - "Worker validates Origin header for security"
    - "Worker returns appropriate errors for missing/invalid URL parameter"
  artifacts:
    - path: "worker/proxy.js"
      provides: "Cloudflare Worker fetch handler with CORS support"
      min_lines: 50
    - path: "wrangler.toml"
      provides: "Worker configuration for deployment"
      contains: "name ="
  key_links:
    - from: "worker/proxy.js"
      to: "external URLs"
      via: "fetch() call with target URL"
      pattern: "fetch\\(targetUrl"
---

<objective>
Create Cloudflare Worker CORS proxy that enables fetching x402 configs from arbitrary URLs.

Purpose: Browser CORS policies prevent direct fetching from arbitrary URLs. This proxy adds proper CORS headers and forwards requests, enabling the validation tool to fetch configs from any x402 endpoint.

Output: Worker code ready for deployment, wrangler configuration file.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-input-proxy/02-RESEARCH.md
@.planning/phases/02-input-proxy/02-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Cloudflare Worker proxy with CORS handling</name>
  <files>worker/proxy.js, wrangler.toml</files>
  <action>
    Create `worker/` directory and Cloudflare Worker files:

    **worker/proxy.js:**
    - Export default fetch handler (Cloudflare Workers format)
    - Handle OPTIONS preflight requests with proper CORS headers
    - Extract target URL from `?url=` query parameter
    - Validate target URL format using URL constructor
    - Validate Origin header against allowed origins (localhost:8000, localhost:3000 for dev)
    - Forward GET requests to target URL with User-Agent header
    - Clone response and add CORS headers:
      - Access-Control-Allow-Origin: request Origin
      - Access-Control-Allow-Methods: GET, HEAD, POST, OPTIONS
      - Access-Control-Expose-Headers: PAYMENT-REQUIRED, X-Payment
    - Return 400 for missing URL parameter
    - Return 403 for disallowed Origin
    - Return 502 for proxy fetch errors
    - Include error messages in response body for debugging

    **wrangler.toml:**
    - name = "x402-proxy"
    - main = "proxy.js"
    - compatibility_date = current date (2024-01-01)
    - Comment noting deployment command: `npx wrangler deploy`

    **Security considerations from research:**
    - Always validate Origin header to prevent open proxy abuse
    - Don't allow proxying to internal IPs (169.254.x.x, 10.x.x.x, 192.168.x.x)
    - Set appropriate timeout on fetch

    Reference Pattern 3 from 02-RESEARCH.md for implementation structure.
  </action>
  <verify>
    Files exist: `ls worker/proxy.js worker/wrangler.toml`
    Worker exports fetch handler: `grep "export default" worker/proxy.js`
    Handles OPTIONS: `grep "OPTIONS" worker/proxy.js`
    Validates Origin: `grep "Origin" worker/proxy.js`
  </verify>
  <done>
    worker/proxy.js contains complete Cloudflare Worker with:
    - CORS preflight handling
    - URL parameter extraction and validation
    - Origin header validation
    - Request forwarding with proper headers
    - Error responses for invalid requests
    wrangler.toml configured for deployment
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Deploy Worker and record URL</name>
  <action>
    User deploys the Cloudflare Worker and provides the deployed URL.
  </action>
  <instructions>
    1. Open terminal in project root
    2. If first time: `npx wrangler login` (opens browser for Cloudflare auth)
    3. Deploy: `cd worker && npx wrangler deploy`
    4. Copy the deployed URL (looks like: https://x402-proxy.{account}.workers.dev)
    5. Respond with the URL

    Expected output:
    ```
    Deployed x402-proxy
    https://x402-proxy.youraccount.workers.dev
    ```

    The URL will be needed for Plan 02-02 to configure fetch requests.
  </instructions>
  <verify>User provides deployed worker URL</verify>
  <done>Worker deployed, URL recorded for use in input.js</done>
  <resume-signal>Paste the deployed worker URL (e.g., https://x402-proxy.xxx.workers.dev)</resume-signal>
</task>

</tasks>

<verification>
- [ ] worker/proxy.js exists with fetch handler
- [ ] wrangler.toml exists with correct configuration
- [ ] Worker deployed to Cloudflare
- [ ] Deployed URL obtained for Plan 02-02
</verification>

<success_criteria>
Cloudflare Worker deployed and accessible, ready to proxy requests for URL validation in Plan 02-02.
</success_criteria>

<output>
After completion, create `.planning/phases/02-input-proxy/02-01-SUMMARY.md`

Record the deployed worker URL in the summary for Plan 02-02 to reference.
</output>
