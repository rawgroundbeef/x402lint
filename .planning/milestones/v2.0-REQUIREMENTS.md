# Requirements Archive: v2.0 Spec-Compliant SDK

**Archived:** 2026-02-04
**Status:** ✅ SHIPPED

This is the archived requirements specification for v2.0.
For current requirements, see `.planning/REQUIREMENTS.md` (created for next milestone).

---

## v2.0 Requirements

Requirements for spec-compliant SDK extraction and website rebuild.

### SDK Core API

- [x] **API-01**: `validate(config)` returns structured `{ valid, errors, warnings, version, normalized }` — never throws on invalid input
- [x] **API-02**: `detect(config)` returns `'v2' | 'v1' | 'flat-legacy' | 'unknown'` based on structural markers
- [x] **API-03**: `normalize(config)` converts any recognized format to canonical v2 shape, returns `null` if unparseable
- [x] **API-04**: All public APIs accept `string | object` input (JSON string or parsed object)
- [x] **API-05**: `validate()` includes `normalized` field in result (null only if completely unparseable)
- [x] **API-06**: `validate(config, { strict: true })` promotes all warnings to errors
- [x] **API-07**: Public API exported as named exports only (no default export) — `{ validate, detect, normalize }`

### Validation Rules

- [x] **RULE-01**: Level 1 — input must be valid JSON, must be an object, must have recognized format
- [x] **RULE-02**: Level 2 — `x402Version` must be present (error for v2, warning for v1/flat), must be 1 or 2
- [x] **RULE-03**: Level 2 — `accepts` array must exist and be non-empty
- [x] **RULE-04**: Level 2 — `resource` object should exist in v2 (warning), `resource.url` should be valid URL
- [x] **RULE-05**: Level 3 — `scheme` must be present (error for v2, warning for v1/flat)
- [x] **RULE-06**: Level 3 — `network` must be present and use CAIP-2 format (`namespace:reference`)
- [x] **RULE-07**: Level 3 — `amount` (v2) / `maxAmountRequired` (v1) must be present, numeric string, positive
- [x] **RULE-08**: Level 3 — `asset` must be present
- [x] **RULE-09**: Level 3 — `payTo` must be present
- [x] **RULE-10**: Level 3 — `maxTimeoutSeconds` should be present in v2 (warning), must be positive integer if present
- [x] **RULE-11**: Level 5 — Legacy format warnings: flat format, v1 field names, simple chain names, alias fields, missing scheme defaults

### Error Reporting

- [x] **ERR-01**: Machine-readable error codes (`MISSING_SCHEME`, `INVALID_NETWORK_FORMAT`, etc.) as `as const` string constants
- [x] **ERR-02**: Field path in dot-notation format (`accepts[0].network`) on every issue
- [x] **ERR-03**: Human-readable error messages that a developer unfamiliar with x402 can understand
- [x] **ERR-04**: Actionable fix suggestions where correct value can be inferred (e.g., `"Use 'eip155:8453' instead of 'base'"`)
- [x] **ERR-05**: Errors vs warnings distinction — errors mean config will fail at runtime, warnings mean suboptimal but functional

### Address Validation

- [x] **ADDR-01**: EVM address must be 42-char hex with `0x` prefix
- [x] **ADDR-02**: EVM address checksum validation (EIP-55) using vendored keccak256
- [x] **ADDR-03**: Solana address must be valid Base58, 32-byte decoded length
- [x] **ADDR-04**: Address format must match network type (EVM address on Solana network = error)
- [x] **ADDR-05**: Address validation dispatches by CAIP-2 namespace (`eip155:*` → EVM, `solana:*` → Solana)

### Network & Asset Registry

- [x] **REG-01**: Known CAIP-2 network registry (Base, Base Sepolia, Avalanche, Avalanche Fuji, Solana mainnet/devnet/testnet, Stellar, Aptos)
- [x] **REG-02**: Unknown but valid CAIP-2 format produces warning, not error
- [x] **REG-03**: Simple chain name → CAIP-2 mapping for legacy detection and fix suggestions
- [x] **REG-04**: Known asset addresses per network (USDC on Base, Solana, etc.)
- [x] **REG-05**: Unknown assets produce warning, not error
- [x] **REG-06**: Extensible chain validation — new chains can be added via community PRs to registry files

### Format Detection & Normalization

- [x] **FMT-01**: Detect v2 (has `accepts` + `x402Version: 2` + `resource`)
- [x] **FMT-02**: Detect v1 (has `accepts` + `x402Version: 1`, no `resource`)
- [x] **FMT-03**: Detect flat-legacy (root-level `payTo`/`amount`/`network` or `payments` array)
- [x] **FMT-04**: Return `unknown` for unrecognized shapes
- [x] **FMT-05**: Normalize flat-legacy → canonical v2 (wrap in `accepts[]`, map field names, set `scheme: "exact"`)
- [x] **FMT-06**: Normalize v1 → canonical v2 (`maxAmountRequired` → `amount`, per-entry `resource` → top-level)
- [x] **FMT-07**: Normalize v2 → pass through unchanged
- [x] **FMT-08**: Preserve `extra` and `extensions` through normalization

### Crypto Vendoring

- [x] **CRYPTO-01**: Vendored keccak256 implementation (NOT SHA-3) with empty-string canary test
- [x] **CRYPTO-02**: Vendored Base58 decoder handling leading-zero bytes correctly
- [x] **CRYPTO-03**: EIP-55 checksum function built on vendored keccak256
- [x] **CRYPTO-04**: Zero runtime dependencies — all crypto is vendored source code

### Build & Package

- [x] **BUILD-01**: TypeScript source compiled to ESM (`index.js`), CJS (`index.cjs`), and browser IIFE (`index.iife.js`)
- [x] **BUILD-02**: TypeScript declarations generated (`.d.ts` and `.d.cts`)
- [x] **BUILD-03**: Browser bundle exposes `window.x402Lint` with `{ validate, detect, normalize }`
- [x] **BUILD-04**: Browser bundle under 30KB minified (~27KB actual, ~9KB gzipped — revised from 15KB due to vendored crypto)
- [x] **BUILD-05**: `package.json` with correct `exports`, `main`, `module`, `types`, `files` fields
- [x] **BUILD-06**: Monorepo structure — SDK in `packages/x402lint/`, website at root, npm workspaces

### Testing

- [x] **TEST-01**: Unit tests for every validation rule (each error code exercised)
- [x] **TEST-02**: Format detection tests (v2, v1, flat-legacy, unknown)
- [x] **TEST-03**: Normalization tests (flat → v2, v1 → v2, v2 passthrough, extra/extensions preserved)
- [x] **TEST-04**: Address validation tests (valid/invalid EVM, valid/invalid Solana, network mismatch)
- [x] **TEST-05**: Crypto primitive tests (keccak256 canary, Base58 leading zeros, EIP-55 reference vectors)
- [x] **TEST-06**: Integration tests (real-world configs, round-trip normalize→validate)
- [x] **TEST-07**: JSON fixture files for reproducible testing
- [x] **TEST-08**: 100+ test cases total

### Website Integration

- [x] **WEB-01**: Replace `validator.js` + `chains.js` with SDK UMD bundle via CDN `<script>` tag
- [x] **WEB-02**: `input.js` calls SDK `validate()` instead of `validateX402Config()`
- [x] **WEB-03**: Map SDK result shape to display code (handle 8+ field name changes)
- [x] **WEB-04**: Update example configs to canonical v2 format
- [x] **WEB-05**: Remove ethers.js and bs58 CDN dependencies (~810KB savings)

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| API-01 | Phase 8 | Complete |
| API-02 | Phase 6 | Complete |
| API-03 | Phase 6 | Complete |
| API-04 | Phase 6 | Complete |
| API-05 | Phase 8 | Complete |
| API-06 | Phase 8 | Complete |
| API-07 | Phase 6 | Complete |
| RULE-01 through RULE-11 | Phase 8 | Complete |
| ERR-01 through ERR-05 | Phase 6 | Complete |
| ADDR-01 through ADDR-05 | Phase 7 | Complete |
| REG-01 through REG-06 | Phase 6 | Complete |
| FMT-01 through FMT-08 | Phase 6 | Complete |
| CRYPTO-01 through CRYPTO-04 | Phase 7 | Complete |
| BUILD-01 through BUILD-05 | Phase 9 | Complete |
| BUILD-06 | Phase 5 | Complete |
| TEST-01 through TEST-08 | Phase 7-8 | Complete |
| WEB-01 through WEB-05 | Phase 10 | Complete |

---

## Milestone Summary

**Shipped:** 65 of 65 v2.0 requirements
**Adjusted:**
- BUILD-04: Browser bundle size target revised from 15KB to 30KB due to vendored crypto (~27KB actual, 9KB gzipped)
- WEB-01: Changed from CDN `<script>` to local IIFE bundle symlink (package not yet published to npm)

**Dropped:** None

---
*Archived: 2026-02-04 as part of v2.0 milestone completion*
