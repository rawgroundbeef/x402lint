# Milestone v2.0: Spec-Compliant SDK

**Status:** ✅ SHIPPED 2026-02-04
**Phases:** 5-10
**Total Plans:** 12

## Overview

v2.0 extracts the validation logic from the plain HTML/JS website into a standalone TypeScript npm package (`packages/x402lint/`) that correctly implements the canonical x402 v1/v2 specs. The SDK exposes three synchronous pure-function APIs -- `validate()`, `detect()`, `normalize()` -- with zero runtime dependencies, vendored crypto primitives, and ESM/CJS/UMD build outputs. The website is then rebuilt on top of the SDK's browser bundle, replacing ~810KB of CDN scripts with a single ~27KB IIFE bundle (~9KB gzipped).

## Phases

### Phase 5: Repository Restructuring

**Goal**: SDK code has a home -- monorepo structure enables all subsequent SDK development without breaking the live website
**Depends on**: Nothing (first v2.0 phase)
**Plans**: 1 plan

Plans:
- [x] 05-01: Monorepo scaffold, website move, and SDK package skeleton

**Details:**
- Created pnpm workspace with 4 members: root, @x402lint/website, @x402lint/config, x402lint
- Moved all website files to apps/website/ preserving git history
- Set up SDK package skeleton with TypeScript strict mode, vitest, and tsdown
- Established shared TypeScript base config with maximum strictness

### Phase 6: Types, Detection, and Normalization

**Goal**: The SDK's type system, error vocabulary, format detection, normalization pipeline, and chain/asset registries are complete
**Depends on**: Phase 5
**Plans**: 3 plans

Plans:
- [x] 06-01: Type system, error codes, and public API signatures
- [x] 06-02: Format detection and normalization
- [x] 06-03: Network and asset registries

**Details:**
- 27 error codes with compile-time enforced human-readable messages
- detect() returning ConfigFormat union ('v2' | 'v1' | 'flat-legacy' | 'unknown')
- normalize() converting all formats to canonical v2 shape
- Network registry with 11 chains (Base, Avalanche, Solana, Stellar, Aptos)
- Asset registry with USDC addresses per network
- CAIP-2 format validation separate from registry lookup

### Phase 7: Crypto Vendoring and Address Validation

**Goal**: Vendored crypto primitives are proven correct against reference test vectors, and address validation dispatches by chain type
**Depends on**: Phase 6
**Plans**: 2 plans

Plans:
- [x] 07-01: Keccak-256 and Base58 vendoring with test vectors
- [x] 07-02: Address validation rules (EVM, Solana, dispatch by CAIP-2 namespace)

**Details:**
- Installed @noble/hashes and @scure/base as devDependencies (zero runtime deps via tree-shaking)
- Keccak-256 (NOT SHA-3) with canary tests
- Base58 decoder preserving leading zero bytes
- EIP-55 checksum encoder and validator
- Chain-specific validators with CAIP-2 namespace dispatch
- Cross-chain mismatch detection

### Phase 8: Validation Rules and Orchestrator

**Goal**: The complete validate() API works end-to-end
**Depends on**: Phase 7
**Plans**: 3 plans

Plans:
- [x] 08-01: Validation rule modules (structure, version, fields, network, amount, legacy)
- [x] 08-02: Orchestrator pipeline and public validate() API
- [x] 08-03: Integration tests and JSON fixture suite

**Details:**
- 6 validation rule modules organized by level (L1-L5)
- Pipeline composition: structure → normalize → level2 → per-entry level3-4 → level5 → strict
- Never-throw public API with try/catch safety net
- Strict mode promoting warnings to errors for CI/CD
- 217 total tests with JSON fixtures and round-trip validation

### Phase 9: Build Pipeline and Package Publishing

**Goal**: The SDK produces correct ESM, CJS, and browser IIFE bundles with working type declarations
**Depends on**: Phase 8
**Plans**: 1 plan

Plans:
- [x] 09-01: Build config (tsdown), output verification, and package.json exports

**Details:**
- Multi-format build: ESM (index.js), CJS (index.cjs), IIFE (index.iife.js)
- TypeScript declarations for both ESM (.d.ts) and CJS (.d.cts)
- publint validated with zero errors/warnings
- IIFE bundle: 26.78KB minified, 9.06KB gzipped

### Phase 10: Website Integration

**Goal**: The live website uses the SDK browser bundle instead of the old validator.js
**Depends on**: Phase 9
**Plans**: 2 plans

Plans:
- [x] 10-01: SDK bundle integration and adapter layer
- [x] 10-02: Example config updates and CDN cleanup

**Details:**
- Replaced 5 script tags with 2 (SDK IIFE + input.js)
- Adapter layer mapping SDK validate() to display-compatible shape
- Example configs updated to canonical v2 format with CAIP-2 networks
- Deleted legacy validator.js and chains.js

---

## Milestone Summary

**Key Decisions:**
- Use @noble/hashes and @scure/base as devDependencies (tree-shakeable with bundler)
- IIFE format instead of UMD (tsdown supports IIFE natively, functionally equivalent)
- Named exports only (no default exports) for IIFE compatibility
- Checksum issues are warnings (not errors) -- all-lowercase addresses are valid but risky
- Separate runPipeline() from validate() for clean try/catch boundary
- Omit SRI integrity hash until package published to npm
- Remove flat-legacy format support post-milestone (x402Version required)

**Issues Resolved:**
- TypeScript strict mode edge cases (noUncheckedIndexedAccess, exactOptionalPropertyTypes)
- @noble/hashes import requires .js extension per package.json exports
- publint types warning resolved with split import/require conditions
- IIFE bundle size (27KB) exceeds initial 15KB target due to vendored crypto -- acceptable for zero runtime deps
- jsdelivr CDN 404 before npm publish -- switched to local IIFE bundle symlink

**Issues Deferred:**
- npm publishing (PUB-01, PUB-02, PUB-03 deferred to future)
- Stellar address validation (StrKey encoding)
- Aptos address validation (hex format)
- Bitcoin address validation (Base58Check, Bech32)

**Technical Debt Incurred:**
- Local IIFE bundle symlink instead of CDN -- needs npm publish + CDN URL update
- SRI integrity hash omitted -- add during publish workflow
- Stellar and Aptos address validation accept any string (deep validation deferred)

---

_For current project status, see .planning/ROADMAP.md_
